<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generador de Recibos Médicos</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Iconos Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    
    <!-- jsPDF (Librería base) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- jsPDF-AutoTable (Para tablas nativas en PDF) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* FONDO DEL FORMULARIO CAMBIADO A GRIS CLARO (bg-gray-50) */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f9fafb; /* gray-50 */
        }
        .container-wrapper {
             /* Wrapper para mantener el color de fondo consistente */
             background-color: #f9fafb;
        }
        
        @media print {
            body * {
                visibility: hidden;
            }
            #receipt-preview, #receipt-preview * {
                visibility: visible;
            }
            #receipt-preview {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
            }
            .no-print {
                display: none;
            }
        }
        
        /* Botones de lista (Modales) */
        .list-btn {
            border-radius: 50%;
            width: 28px;
            height: 28px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            font-size: 0.8rem; 
            cursor: pointer;
        }
        .delete-btn-list {
             background: #fef2f2; /* red-50 */
             color: #ef4444; /* red-500 */
             border: 1px solid #fecaca; /* red-200 */
        }
        .delete-btn-list:hover {
            background: #ef4444; /* red-500 */
            color: white;
        }
        .edit-btn-list {
            background: #faf5ff; /* purple-50 */
            color: #9333ea; /* purple-600 */
            border: 1px solid #e9d5ff; /* purple-200 */
            margin-right: 8px;
        }
        .edit-btn-list:hover {
            background: #9333ea; /* purple-600 */
            color: white;
        }
        
        /* NUEVO: Botón para eliminar item de la tabla del recibo */
        .delete-item-btn {
            background: #fef2f2; /* red-50 */
            color: #ef4444; /* red-500 */
            border: 1px solid #fecaca; /* red-200 */
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9rem;
            font-weight: bold;
            line-height: 1;
            transition: all 0.2s;
            cursor: pointer;
        }
        .delete-item-btn:hover {
            background: #ef4444; /* red-500 */
            color: white;
        }
        

        /* --- INICIO DE CORRECCIÓN DE PDF --- */
        /* Reducir padding y tamaños de fuente para que el PDF se genere más compacto */
        #receipt-preview {
            padding: 1.25rem; /* p-5, más pequeño que p-8 */
        }
        /* Estos estilos anulan las clases de Tailwind dentro de la vista previa para el renderizado */
        #receipt-preview header h2 { font-size: 1rem; } /* text-base */
        #receipt-preview header p { font-size: 0.875rem; } /* text-sm */
        #receipt-preview header .text-right { font-size: 0.875rem; } /* text-sm */
        
        #preview-recipient-info { 
            font-size: 8pt; /* text-xs, 12px. Usar pt para consistencia de PDF */
            line-height: 1.3;
            margin-top: 0.75rem; 
            margin-bottom: 0.75rem; 
        }
        #preview-recipient-name { 
            font-size: 9pt; 
            font-weight: 600; 
        } 
        
        #receipt-preview h3.text-xl { /* Título "Servicios Médicos" */
            font-size: 1.125rem; /* text-lg */
            margin-top: 1rem;
            margin-bottom: 0.5rem;
        }

        /* Reducir el tamaño de fuente de la tabla (muy importante) */
        #receipt-items-container table {
            font-size: 8pt; /* Usar 'pt' es más consistente para PDF */
            line-height: 1.2;
        }
        #receipt-items-container table th,
        #receipt-items-container table td {
            padding: 3px 4px; /* Padding de celdas más pequeño */
        }
        
        /* Reducir espacio y tamaño en Totales */
        #receipt-preview section.mt-8 { 
            margin-top: 1rem; /* Menos espacio arriba de los totales */
        }
        #receipt-preview .bg-purple-50 { 
            padding: 0.75rem; /* p-3 */
        }
        #receipt-preview .bg-purple-50 .text-base { font-size: 9pt; }
        #receipt-preview .bg-purple-50 .text-xl { font-size: 10pt; font-weight: 700; }
        
        /* Pie de página */
        #receipt-preview footer.mt-12 {
            margin-top: 1.5rem; /* mt-6 */
            font-size: 7pt; /* Muy pequeño, como en los recibos de referencia */
        }
        /* --- FIN DE CORRECCIÓN DE PDF --- */

    </style>
</head>
<body class="text-purple-900 container-wrapper">

    <div class="container mx-auto p-4 lg:p-8">
        <header class="text-center mb-8 no-print">
            <h1 class="text-4xl font-bold text-fuchsia-600">Generador de Recibos</h1>
        </header>

        <main class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <!-- Columna de Controles (ahora 1/2 parte) -->
            <div class="bg-white p-6 rounded-2xl shadow-lg no-print space-y-8 lg:col-span-1">
                <!-- Información General -->
                <div>
                    <h2 class="text-2xl font-bold mb-6 border-b pb-3 text-purple-800">Información General</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <!-- CAMPO EMISOR (DATALIST) -->
                        <div>
                            <label for="emitter-input" class="block text-sm font-medium text-gray-900 mb-1">Emisor (DE:)</label>
                            <input list="emitter-options" id="emitter-input" placeholder="Escriba para buscar o seleccionar..." class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-purple-500 text-gray-800" required>
                            <datalist id="emitter-options"></datalist>
                            <input type="hidden" id="emitter-select-id">
                        </div>
                        <!-- CAMPO RECEPTOR (DATALIST) -->
                        <div>
                            <label for="recipient-input" class="block text-sm font-medium text-gray-900 mb-1">Ente Receptor (PARA:)</label>
                            <input list="recipient-options" id="recipient-input" placeholder="Escriba para buscar o seleccionar..." class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-purple-500 text-gray-800" required>
                            <datalist id="recipient-options"></datalist>
                            <input type="hidden" id="recipient-select-id">
                        </div>
                        <div>
                            <label for="receipt-date" class="block text-sm font-medium text-gray-900 mb-1">Fecha del Recibo</label>
                            <input type="date" id="receipt-date" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition text-gray-800">
                        </div>
                        <div>
                            <label for="bcv-rate" class="block text-sm font-medium text-gray-900 mb-1">Tasa BCV (Bs. por $)</label>
                            <input type="number" id="bcv-rate" placeholder="Ej: 36.50" step="0.00001" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition text-gray-800">
                        </div>
                        <div>
                            <label for="receipt-number-input" class="block text-sm font-medium text-gray-900 mb-1">N° Recibo (Opcional)</label>
                            <input type="text" id="receipt-number-input" placeholder="Ej: 002" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition text-gray-800 disabled:bg-gray-100">
                        </div>
                    </div>
                </div>

                <!-- Añadir Servicio al Recibo -->
                <div>
                    <h2 class="text-2xl font-bold mb-4 border-b pb-3 text-purple-800">Añadir al Recibo</h2>
                    <form id="add-item-form" class="space-y-4">
                        <!-- CAMPO TRABAJADOR (DATALIST) -->
                        <div>
                            <label for="worker-input" class="block text-sm font-medium text-gray-900 mb-1">Nombres</label>
                            <input list="worker-options" id="worker-input" placeholder="Escriba para buscar o seleccionar..." class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-purple-500 text-gray-800" required>
                            <datalist id="worker-options"></datalist>
                            <input type="hidden" id="worker-select-id">
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="patient-name" class="block text-sm font-medium text-gray-900 mb-1">Nombre del Paciente (Familiar)</label>
                                <input type="text" id="patient-name" placeholder="(Opcional, se usa el familiar por defecto)" class="w-full p-2 border border-gray-300 rounded-md text-gray-800">
                            </div>
                            <!-- CAMPO NUEVO: Fecha del Servicio -->
                            <div>
                                <label for="service-date" class="block text-sm font-medium text-gray-900 mb-1">Fecha del Servicio</label>
                                <input type="date" id="service-date" class="w-full p-2 border border-gray-300 rounded-md text-gray-800" required>
                            </div>
                        </div>

                        <!-- CAMPO SERVICIO (DATALIST) -->
                        <div>
                            <label for="service-input" class="block text-sm font-medium text-gray-900 mb-1">Servicio</LAbel>
                            <input list="service-options" id="service-input" placeholder="Escriba para buscar o seleccionar..." class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-purple-500 text-gray-800" required>
                            <datalist id="service-options"></datalist>
                            <input type="hidden" id="service-select-id">
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                             <div>
                                <label for="service-quantity" class="block text-sm font-medium text-gray-900 mb-1">Cantidad</p>
                                <input type="number" id="service-quantity" value="1" min="1" class="w-full p-2 border border-gray-300 rounded-md text-gray-800" required>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-900 mb-1">Precio Unit. ($)</label>
                                <p id="service-price-display" class="w-full p-2 bg-gray-100 rounded-md text-gray-500">$0.00</p>
                            </div>
                        </div>
                        <!-- BOTÓN AGREGAR (NUEVO ESTILO) -->
                        <button type="submit" class="w-full bg-purple-200 text-purple-900 font-bold py-3 px-6 rounded-full hover:bg-purple-300 transition duration-300 flex items-center justify-center shadow-lg shadow-purple-200/50">
                            <i class="fas fa-plus mr-2"></i> Agregar al Recibo
                        </button>
                    </form>
                </div>
                
                 <!-- Gestión de Catálogos -->
                <div class="space-y-4 pt-4">
                    <h2 class="text-2xl font-bold mb-4 border-b pb-3 text-purple-800">Gestión de Catálogos</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <button id="manage-emitters-btn" class="w-full bg-purple-100 hover:bg-purple-200 text-purple-800 font-bold py-3 px-4 rounded-md flex items-center justify-center">
                            <i class="fas fa-user-tie mr-2"></i> Gestionar Emisores
                        </button>
                        <button id="manage-recipients-btn" class="w-full bg-purple-100 hover:bg-purple-200 text-purple-800 font-bold py-3 px-4 rounded-md flex items-center justify-center">
                            <i class="fas fa-building mr-2"></i> Gestionar Entes
                        </button>
                        <button id="manage-workers-btn" class="w-full bg-purple-100 hover:bg-purple-200 text-purple-800 font-bold py-3 px-4 rounded-md flex items-center justify-center">
                            <i class="fas fa-users mr-2"></i> Gestionar Pacientes
                        </button>
                        <button id="manage-services-btn" class="w-full bg-purple-100 hover:bg-purple-200 text-purple-800 font-bold py-3 px-4 rounded-md flex items-center justify-center">
                            <i class="fas fa-stethoscope mr-2"></i> Gestionar Servicios
                        </button>
                    </div>
                </div>

            </div>

            <!-- Columna de Vista Previa (ahora 1/2 parte) -->
            <div class="lg:col-span-1">
                <div id="receipt-preview" class="bg-white p-8 rounded-2xl shadow-lg min-h-full text-gray-800">
                    <header class="flex justify-between items-start pb-4 border-b-2 border-gray-200">
                        <div>
                            <h2 id="preview-emitter-name" class="text-lg font-bold text-purple-900">Nombre del Emisor</h2>
                            <p id="preview-emitter-rif" class="text-purple-700 text-sm"></p>
                            <p id="preview-emitter-desc" class="text-purple-700 text-sm">Descripción</p>
                        </div>
                        <div class="text-right text-sm text-gray-500">
                            <p class="font-semibold">Fecha: <span id="preview-date">--/--/----</span></p>
                            <p id="preview-receipt-number-wrapper" style="display: none;">Recibo N°: <span id="preview-receipt-number">N/A</span></p>
                        </div>
                    </header>
                    
                    <section id="preview-recipient-info" class="my-6 text-sm">
                        <div>
                            <p id="preview-recipient-name" class="font-semibold text-base">Seleccione un ente receptor</p>
                            <p id="preview-recipient-rif" class="text-gray-600"></p>
                            <p id="preview-recipient-address" class="text-gray-600"></p>
                            <p id="preview-recipient-phone" class="text-gray-600"></p>
                        </div>
                    </section>

                    <h3 class="text-xl font-bold text-purple-800 mt-6 mb-4">Servicios Médicos</h3>

                    <!-- SECCIÓN DE ITEMS REESTRUCTURADA (AHORA ES UNA SOLA TABLA) -->
                    <section id="receipt-items-container">
                        <!-- Items del recibo se renderizan aquí como una sola tabla -->
                         <p class="text-center text-gray-500 py-10">Aún no se han agregado items al recibo.</p>
                    </section>

                    <section class="mt-8 flex justify-end">
                        <div class="w-full md:w-1/2 lg:w-2/3">
                            <div class="bg-purple-50 p-4 rounded-lg space-y-2">
                                <div class="flex justify-between text-base font-semibold">
                                    <span>Subtotal ($)</span>
                                    <span id="subtotal-usd">$0.00</span>
                                </div>
                                <div class="flex justify-between text-base text-purple-700">
                                    <span>Tasa BCV</span>
                                    <span>Bs. <span id="preview-bcv-rate">0.00</span></span>
                                </div>
                                <hr>
                                <div class="flex justify-between text-xl font-bold text-purple-900 pt-2">
                                    <span>TOTAL (Bs.)</span>
                                    <span id="total-bs">Bs. 0.00</span>
                                </div>
                            </div>
                        </div>
                    </section>
                    
                    <footer class="text-center mt-12 text-xs text-gray-400">
                        <p>Gracias por su confianza.</p>
                        <p>Este es un recibo informativo, no es una factura fiscal.</p>
                    </footer>
                </div>
                 <div class="text-center mt-6 no-print">
                    <button id="download-pdf-button" class="bg-green-200 text-green-900 font-bold py-3 px-8 rounded-full hover:bg-green-300 transition duration-300 flex items-center justify-center mx-auto mb-2 w-full md:w-auto md:inline-flex shadow-lg shadow-green-200/50">
                        <i class="fas fa-file-pdf mr-2"></i> Descargar PDF
                    </button>
                    <button id="reset-button" class="bg-yellow-200 text-yellow-900 font-bold py-3 px-8 rounded-full hover:bg-yellow-300 transition duration-300 md:ml-2 flex items-center justify-center mx-auto w-full md:w-auto md:inline-flex shadow-lg shadow-yellow-200/50">
                        <i class="fas fa-arrow-left mr-2"></i> Limpiar Formulario
                    </button>
                </div>
            </div>
        </main>
    </div>

    <!-- ===== MODALS ===== -->

    <!-- Custom Modal for Reset Confirmation -->
    <div id="reset-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center no-print hidden z-50 p-4">
        <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-sm text-gray-800">
            <h3 class="text-lg font-semibold mb-4">Confirmar Acción</h3>
            <p class="text-gray-600 mb-6">¿Estás seguro de que quieres limpiar todo el recibo?</p>
            <div class="flex justify-end gap-4">
                <button id="cancel-reset-btn" class="py-2 px-4 bg-purple-100 text-purple-800 rounded-md hover:bg-purple-200 flex items-center">
                    <i class="fas fa-times mr-2"></i>Cancelar
                </button>
                <button id="confirm-reset-btn" class="py-2 px-4 bg-red-600 text-white rounded-md hover:bg-red-700 flex items-center">
                    <i class="fas fa-check mr-2"></i>Confirmar
                </button>
            </div>
        </div>
    </div>
    
    <!-- Emitters Modal -->
    <div id="emitters-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center no-print hidden z-50 p-4">
        <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-2xl text-gray-800">
            <div class="flex justify-between items-center mb-4 border-b pb-2">
                <h3 class="text-2xl font-bold text-purple-800">Gestionar Emisores</h3>
                <button id="close-emitters-modal-btn" class="text-gray-400 hover:text-gray-600 text-2xl">&times;</button>
            </div>
            <!-- Form -->
            <form id="emitter-form" class="space-y-4 mb-4">
                <input type="hidden" id="emitter-edit-id">
                <input type="text" id="emitter-name-input" placeholder="Nombre del Emisor (Ej: Dra. ...)" class="w-full p-2 border rounded-md text-gray-800" required>
                <input type="text" id="emitter-rif-input" placeholder="RIF (Ej: J-123...)" class="w-full p-2 border rounded-md text-gray-800">
                <input type="text" id="emitter-desc-input" placeholder="Descripción (Ej: Ginecólogo)" class="w-full p-2 border rounded-md text-gray-800" required>
                
                <div class="flex items-center">
                    <input type="checkbox" id="emitter-correlative-input" class="h-4 w-4 text-purple-600 border-gray-300 rounded focus:ring-purple-500">
                    <label for="emitter-correlative-input" class="ml-2 block text-sm text-gray-900">Usar correlativo de recibo</label>
                </div>

                <button type="submit" id="emitter-submit-btn" class="w-full bg-purple-100 hover:bg-purple-200 text-purple-800 font-bold py-2 px-4 rounded-md flex items-center justify-center">
                    <i class="fas fa-plus mr-2"></i> Añadir Emisor
                </button>
            </form>
            <!-- List -->
            <ul id="emitters-list" class="space-y-2 max-h-64 overflow-y-auto pr-2 text-gray-800">
                <!-- Emisores se renderizan aquí -->
            </ul>
        </div>
    </div>

    <!-- Recipients Modal -->
    <div id="recipients-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center no-print hidden z-50 p-4">
        <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-2xl text-gray-800">
            <div class="flex justify-between items-center mb-4 border-b pb-2">
                <h3 class="text-2xl font-bold text-purple-800">Gestionar Entes Receptores</h3>
                <button id="close-recipients-modal-btn" class="text-gray-400 hover:text-gray-600 text-2xl">&times;</button>
            </div>
            <!-- Form -->
            <form id="recipient-form" class="space-y-2 mb-4">
                <input type="hidden" id="recipient-edit-id">
                <input type="text" id="recipient-name-input" placeholder="Nombre del Ente" class="w-full p-2 border rounded-md text-gray-800" required>
                <input type="text" id="recipient-rif-input" placeholder="RIF (Ej: J-123...)" class="w-full p-2 border rounded-md text-gray-800">
                <input type="text" id="recipient-address-input" placeholder="Dirección" class="w-full p-2 border rounded-md text-gray-800">
                <input type="text" id="recipient-phone-input" placeholder="Teléfono" class="w-full p-2 border rounded-md text-gray-800">
                <button type="submit" id="recipient-submit-btn" class="w-full bg-purple-100 hover:bg-purple-200 text-purple-800 font-bold py-2 px-4 rounded-md flex items-center justify-center">
                    <i class="fas fa-plus mr-2"></i> Añadir Ente
                </button>
            </form>
            <!-- List -->
            <ul id="recipients-list" class="space-y-2 max-h-64 overflow-y-auto pr-2 text-gray-800">
                <!-- Receptores se renderizan aquí -->
            </ul>
        </div>
    </div>
    
    <!-- Workers Modal -->
    <div id="workers-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center no-print hidden z-50 p-4">
        <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-2xl text-gray-800">
            <div class="flex justify-between items-center mb-4 border-b pb-2">
                <h3 class="text-2xl font-bold text-purple-800">Gestionar Pacientes</h3>
                <button id="close-workers-modal-btn" class="text-gray-400 hover:text-gray-600 text-2xl">&times;</button>
            </div>
            <!-- Form -->
            <form id="worker-form" class="space-y-2 mb-4">
                <input type="hidden" id="worker-edit-id">
                <input type="text" id="worker-name-input" placeholder="Nombre Apellido" class="w-full p-2 border rounded-md text-gray-800" required>
                <input type="text" id="worker-ci-input" placeholder="Ej: V-12345678" class="w-full p-2 border rounded-md text-gray-800" required>
                <input type="text" id="worker-familiar-input" placeholder="Paciente Familiar (Opcional)" class="w-full p-2 border rounded-md text-gray-800">
                <button type="submit" id="worker-submit-btn" class="w-full bg-purple-100 hover:bg-purple-200 text-purple-800 font-bold py-2 px-4 rounded-md flex items-center justify-center">
                    <i class="fas fa-plus mr-2"></i> Añadir Paciente
                </button>
            </form>
            <!-- List -->
            <ul id="workers-list" class="space-y-2 max-h-64 overflow-y-auto pr-2 text-gray-800">
                <!-- Trabajadores se renderizan aquí -->
            </ul>
        </div>
    </div>

    <!-- Services Modal -->
    <div id="services-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center no-print hidden z-50 p-4">
        <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-2xl text-gray-800">
            <div class="flex justify-between items-center mb-4 border-b pb-2">
                <h3 class="text-2xl font-bold text-purple-800">Gestionar Catálogo de Servicios</h3>
                <button id="close-services-modal-btn" class="text-gray-400 hover:text-gray-600 text-2xl">&times;</button>
            </div>
            <!-- Form -->
            <form id="service-form" class="space-y-3 mb-4">
                 <input type="hidden" id="service-edit-id">
                <div>
                    <label for="service-desc-input" class="block text-sm font-medium text-gray-900 mb-1">Descripción del Servicio</label>
                    <input type="text" id="service-desc-input" placeholder="Descripción del servicio" class="w-full p-2 border rounded-md text-gray-800" required>
                </div>
                
                <div class="grid grid-cols-2 gap-3">
                    <div>
                         <label for="service-price-input" class="block text-sm font-medium text-gray-900 mb-1">Precio Total ($)</label>
                        <input type="number" id="service-price-input" placeholder="Ej: 60.00" step="0.01" class="w-full p-2 border rounded-md text-gray-800" required>
                    </div>
                     <div>
                         <label for="service-quantity-input" class="block text-sm font-medium text-gray-900 mb-1">Cantidad (para P/U)</label>
                        <input type="number" id="service-quantity-input" placeholder="Ej: 3" min="1" value="1" class="w-full p-2 border rounded-md text-gray-800" required>
                    </div>
                </div>

                <button type="submit" id="service-submit-btn" class="bg-purple-100 hover:bg-purple-200 text-purple-800 font-bold py-2 px-4 rounded-md flex items-center justify-center">
                    <i class="fas fa-plus mr-2"></i> Añadir
                </button>
            </form>
            <!-- List -->
            <ul id="services-list" class="space-y-2 max-h-64 overflow-y-auto pr-2 text-gray-800">
                <!-- Servicios se renderizan aquí -->
            </ul>
        </div>
    </div>

    <!-- ===== FIN DE MODALS ===== -->


    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- ESTADO Y DATOS ---
        let receiptItems = [];
        let bcvRate = 0.0;
        let nextReceiptNumber = JSON.parse(localStorage.getItem('receiptCorrelative')) || 1;

        // Cargar desde localStorage
        let emitters = JSON.parse(localStorage.getItem('medicalReceiptEmitters')) || [];
        let recipients = JSON.parse(localStorage.getItem('medicalReceiptRecipients')) || [];
        let workers = JSON.parse(localStorage.getItem('medicalReceiptWorkers')) || [];
        let services = JSON.parse(localStorage.getItem('medicalReceiptServices')) || [];

        // --- SELECTORES DEL DOM (COMPLETOS) ---
        
        // Formulario Principal
        const addItemForm = document.getElementById('add-item-form');
        const emitterInput = document.getElementById('emitter-input');
        const emitterOptions = document.getElementById('emitter-options');
        const emitterSelectId = document.getElementById('emitter-select-id');
        const recipientInput = document.getElementById('recipient-input');
        const recipientOptions = document.getElementById('recipient-options');
        const recipientSelectId = document.getElementById('recipient-select-id');
        const receiptDateInput = document.getElementById('receipt-date');
        const bcvRateInput = document.getElementById('bcv-rate');
        const receiptNumberInput = document.getElementById('receipt-number-input');
        const workerInput = document.getElementById('worker-input');
        const workerOptions = document.getElementById('worker-options');
        const workerSelectId = document.getElementById('worker-select-id');
        const patientNameInput = document.getElementById('patient-name');
        const serviceDateInput = document.getElementById('service-date');
        const serviceInput = document.getElementById('service-input');
        const serviceOptions = document.getElementById('service-options');
        const serviceSelectId = document.getElementById('service-select-id');
        const serviceQuantityInput = document.getElementById('service-quantity');
        const servicePriceDisplay = document.getElementById('service-price-display');

        // Vista Previa (Preview)
        const previewEmitterName = document.getElementById('preview-emitter-name');
        const previewEmitterRif = document.getElementById('preview-emitter-rif');
        const previewEmitterDesc = document.getElementById('preview-emitter-desc');
        const previewDate = document.getElementById('preview-date');
        const previewReceiptNumberWrapper = document.getElementById('preview-receipt-number-wrapper');
        const previewReceiptNumber = document.getElementById('preview-receipt-number');
        const previewRecipientName = document.getElementById('preview-recipient-name');
        const previewRecipientRif = document.getElementById('preview-recipient-rif');
        const previewRecipientAddress = document.getElementById('preview-recipient-address');
        const previewRecipientPhone = document.getElementById('preview-recipient-phone');
        const receiptItemsContainer = document.getElementById('receipt-items-container');
        const subtotalUsd = document.getElementById('subtotal-usd');
        const previewBcvRate = document.getElementById('preview-bcv-rate');
        const totalBs = document.getElementById('total-bs');

        // Botones Principales
        const downloadPdfButton = document.getElementById('download-pdf-button');
        const resetButton = document.getElementById('reset-button');
        const resetModal = document.getElementById('reset-modal');
        const cancelResetBtn = document.getElementById('cancel-reset-btn');
        const confirmResetBtn = document.getElementById('confirm-reset-btn');

        // Botones de Gestión de Catálogos
        const manageEmittersBtn = document.getElementById('manage-emitters-btn');
        const manageRecipientsBtn = document.getElementById('manage-recipients-btn');
        const manageWorkersBtn = document.getElementById('manage-workers-btn');
        const manageServicesBtn = document.getElementById('manage-services-btn');

        // Modal de Emisores
        const emittersModal = document.getElementById('emitters-modal');
        const closeEmittersModalBtn = document.getElementById('close-emitters-modal-btn');
        const emitterForm = document.getElementById('emitter-form');
        const emitterEditId = document.getElementById('emitter-edit-id');
        const emitterNameInput = document.getElementById('emitter-name-input');
        const emitterRifInput = document.getElementById('emitter-rif-input');
        const emitterDescInput = document.getElementById('emitter-desc-input');
        const emitterCorrelativeInput = document.getElementById('emitter-correlative-input');
        const emitterSubmitBtn = document.getElementById('emitter-submit-btn');
        const emittersList = document.getElementById('emitters-list');

        // Modal de Receptores
        const recipientsModal = document.getElementById('recipients-modal');
        const closeRecipientsModalBtn = document.getElementById('close-recipients-modal-btn');
        const recipientForm = document.getElementById('recipient-form');
        const recipientEditId = document.getElementById('recipient-edit-id');
        const recipientNameInput = document.getElementById('recipient-name-input');
        const recipientRifInput = document.getElementById('recipient-rif-input');
        const recipientAddressInput = document.getElementById('recipient-address-input');
        const recipientPhoneInput = document.getElementById('recipient-phone-input');
        const recipientSubmitBtn = document.getElementById('recipient-submit-btn');
        const recipientsList = document.getElementById('recipients-list');

        // Modal de Pacientes (Workers)
        const workersModal = document.getElementById('workers-modal');
        const closeWorkersModalBtn = document.getElementById('close-workers-modal-btn');
        const workerForm = document.getElementById('worker-form');
        const workerEditId = document.getElementById('worker-edit-id');
        const workerNameInput = document.getElementById('worker-name-input');
        const workerCiInput = document.getElementById('worker-ci-input');
        const workerFamiliarInput = document.getElementById('worker-familiar-input');
        const workerSubmitBtn = document.getElementById('worker-submit-btn');
        const workersList = document.getElementById('workers-list');

        // Modal de Servicios
        const servicesModal = document.getElementById('services-modal');
        const closeServicesModalBtn = document.getElementById('close-services-modal-btn');
        const serviceForm = document.getElementById('service-form');
        const serviceEditId = document.getElementById('service-edit-id');
        const serviceDescInput = document.getElementById('service-desc-input');
        const servicePriceInput = document.getElementById('service-price-input');
        const serviceQuantityModalInput = document.getElementById('service-quantity-input');
        const serviceSubmitBtn = document.getElementById('service-submit-btn');
        const servicesList = document.getElementById('services-list');


        // --- FUNCIONES DE UTILIDAD ---
        
        // Función para formato Nombre Propio (AHORA SOLO SE USA PARA PACIENTES)
        const toProperCase = (str) => {
            if (!str) return '';
            return str.toLowerCase().replace(/\b\w/g, char => char.toUpperCase());
        };
        
        // Función para formato RIF
        const formatRIF = (rif) => {
            if (!rif) return '';
            let value = rif.toUpperCase().replace(/[^VEJPG0-9]/g, ''); // Permitir V, E, J, P, G y números
            let prefix = value.charAt(0);
            
            if (!isNaN(prefix) || !['V', 'E', 'J', 'P', 'G'].includes(prefix)) {
                prefix = 'J'; // Default a J si es inválido o número
                value = 'J' + value.replace(/[^0-9]/g, ''); // Limpiar no números
            } else {
                value = value.substring(1); // Quitar prefijo para limpiar números
            }
            
            value = value.replace(/[^0-9]/g, ''); // Limpiar solo números
            return `${prefix}-${value}`.substring(0, 12); // Limitar longitud J-12345678-9
        };

        const formatCurrency = (value, type = 'VES') => {
            if (type === 'USD') {
                return value.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            }
            if (type === 'PDF_USD') {
                // Para el PDF, necesitamos un string numérico simple, no uno localizado con comas
                return value.toFixed(2);
            }
            // Para VES (Bolívares)
            return value.toLocaleString('es-VE', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        };
        
        const formatDateDDMMYY = (dateString) => {
            if (!dateString) return '--/--/----';
            // Asumir que la fecha de entrada está en formato 'YYYY-MM-DD'
            const [year, month, day] = dateString.split('-');
            return `${day}/${month}/${year}`;
        };

        const saveToLocalStorage = (key, data) => {
            localStorage.setItem(key, JSON.stringify(data));
        };

        const findIdFromDatalistInput = (inputElement, datalistElement) => {
            const selectedOption = Array.from(datalistElement.options)
                .find(option => option.value === inputElement.value);
            return selectedOption ? parseInt(selectedOption.dataset.id) : null;
        };
        
        const formatCI = (ci) => {
            let value = ci.toUpperCase().replace(/[^VEJP0-9]/g, ''); // Permitir V, E, J, P y números
            let prefix = value.charAt(0);
            
            if (!isNaN(prefix) || !['V', 'E', 'J', 'P'].includes(prefix)) {
                prefix = 'V';
                value = 'V' + value.replace(/[^0-9]/g, '');
            } else {
                value = value.substring(1); // Quitar prefijo para limpiar números
            }
            
            value = value.replace(/[^0-9]/g, ''); // Limpiar solo números
            return `${prefix}-${value}`.substring(0, 11); // Limitar longitud V-12345678
        };


        // --- FUNCIONES DE RENDERIZADO Y POBLADO ---

        // Emitters
        const populateEmittersDatalist = () => {
            emitterOptions.innerHTML = '';
            emitters.forEach(e => {
                const option = document.createElement('option');
                option.value = `${e.name} (${e.rif || e.desc})`;
                option.dataset.id = e.id;
                emitterOptions.appendChild(option);
            });
        };
        const renderEmittersList = () => {
            emittersList.innerHTML = '';
            populateEmittersDatalist();
            emitters.forEach(e => {
                const li = document.createElement('li');
                li.className = 'p-3 bg-purple-50 rounded-md flex justify-between items-center';
                li.innerHTML = `
                    <div>
                        <span class="font-semibold">${e.name}</span>
                        <span class="text-sm text-purple-700 ml-2">(${e.rif ? e.rif + ' - ' : ''}${e.desc}) ${e.useCorrelative ? '<i class="fas fa-hashtag text-xs ml-1" title="Usa correlativo"></i>' : ''}</span>
                    </div>
                    <div>
                        <button class="edit-btn-list" data-id="${e.id}"><i class="fas fa-pencil-alt"></i></button>
                        <button class="delete-btn-list" data-id="${e.id}"><i class="fas fa-trash-alt"></i></button>
                    </div>
                `;
                emittersList.appendChild(li);
            });
        };

        // Recipients
        const populateRecipientsDatalist = () => {
            recipientOptions.innerHTML = '';
            recipients.forEach(r => {
                const option = document.createElement('option');
                option.value = `${r.name} (${r.rif})`;
                option.dataset.id = r.id;
                recipientOptions.appendChild(option);
            });
        };
        const renderRecipientsList = () => {
            recipientsList.innerHTML = '';
            populateRecipientsDatalist();
            recipients.forEach(r => {
                const li = document.createElement('li');
                li.className = 'p-3 bg-purple-50 rounded-md flex justify-between items-center';
                li.innerHTML = `
                    <div>
                        <span class="font-semibold">${r.name}</span>
                        <span class="text-sm text-purple-700 ml-2">(${r.rif})</span>
                    </div>
                    <div>
                        <button class="edit-btn-list" data-id="${r.id}"><i class="fas fa-pencil-alt"></i></button>
                        <button class="delete-btn-list" data-id="${r.id}"><i class="fas fa-trash-alt"></i></button>
                    </div>
                `;
                recipientsList.appendChild(li);
            });
        };

        // Workers (Pacientes)
        const populateWorkersDatalist = () => {
            workerOptions.innerHTML = '';
            workers.forEach(w => {
                const option = document.createElement('option');
                option.value = `${w.name} (${w.ci})`;
                option.dataset.id = w.id;
                workerOptions.appendChild(option);
            });
        };
        const renderWorkersList = () => {
            workersList.innerHTML = '';
            populateWorkersDatalist();
            workers.forEach(w => {
                const li = document.createElement('li');
                li.className = 'p-3 bg-purple-50 rounded-md flex justify-between items-center';
                li.innerHTML = `
                    <div>
                        <span class="font-semibold">${w.name} (${w.ci})</span>
                        ${w.familiar ? `<span class="block text-sm text-purple-700">Familiar: ${w.familiar}</span>` : ''}
                    </div>
                    <div>
                        <button class="edit-btn-list" data-id="${w.id}"><i class="fas fa-pencil-alt"></i></button>
                        <button class="delete-btn-list" data-id="${w.id}"><i class="fas fa-trash-alt"></i></button>
                    </div>
                `;
                workersList.appendChild(li);
            });
        };
        
        // Services
        const populateServicesDatalist = () => {
            serviceOptions.innerHTML = '';
            services.forEach(s => {
                const option = document.createElement('option');
                // MODIFICADO: Se elimina el precio del 'value'
                option.value = s.description;
                option.dataset.id = s.id;
                serviceOptions.appendChild(option);
            });
        };
        const renderServicesList = () => {
            servicesList.innerHTML = '';
            populateServicesDatalist();
            services.forEach(s => {
                const li = document.createElement('li');
                li.className = 'p-3 bg-purple-50 rounded-md flex justify-between items-center';
                li.innerHTML = `
                    <div>
                        <span class="font-semibold">${s.description}</span>
                    </div>
                    <div class="flex items-center">
                        <span class="text-sm text-purple-900 font-bold mr-4">$${formatCurrency(s.price, 'USD')}</span>
                        <button class="edit-btn-list" data-id="${s.id}"><i class="fas fa-pencil-alt"></i></button>
                        <button class="delete-btn-list" data-id="${s.id}"><i class="fas fa-trash-alt"></i></button>
                    </div>
                `;
                servicesList.appendChild(li);
            });
        };
        
        // Preview (Recibo)
        const renderTotals = () => {
            const subtotal = receiptItems.reduce((acc, item) => acc + (item.price * item.quantity), 0);
            const total = subtotal * bcvRate;
            
            subtotalUsd.textContent = `$${formatCurrency(subtotal, 'USD')}`;
            totalBs.textContent = `Bs. ${formatCurrency(total, 'VES')}`;
            previewBcvRate.textContent = formatCurrency(bcvRate, 'VES');
        };
        
        // ==================================================================
        // ===== FUNCIÓN RENDER PREVIEW (MODIFICADA) =====
        // ==================================================================
        const renderReceiptPreview = () => {
            if (receiptItems.length === 0) {
                receiptItemsContainer.innerHTML = '<p class="text-center text-gray-500 py-10">Aún no se han agregado items al recibo.</p>';
                renderTotals();
                return;
            }

            // Ordenar por fecha de servicio
            receiptItems.sort((a, b) => new Date(a.serviceDate) - new Date(b.serviceDate));

            let tableHtml = `
                <!-- NUEVO: Wrapper para scroll horizontal en móvil -->
                <div class="overflow-x-auto rounded-lg border border-gray-200">
                    <!-- NUEVO: min-w-[800px] para forzar scroll en lugar de comprimir -->
                    <table class="w-full min-w-[800px] text-left">
                        <thead class="bg-purple-50 text-purple-900">
                            <tr>
                                <th class="p-2 font-semibold">N°</th>
                                <th class="p-2 font-semibold">Fecha Serv.</th>
                                <th class="p-2 font-semibold">Nombres / C.I / Paciente</th>
                                <th class="p-2 font-semibold">Servicio</th>
                                <th class="p-2 font-semibold text-center">Cant.</th>
                                <th class="p-2 font-semibold text-right">P/U ($)</th>
                                <th class="p-2 font-semibold text-right">Total ($)</th>
                                <!-- NUEVA COLUMNA -->
                                <th class="p-2 font-semibold text-right">Total (Bs.)</th>
                                <!-- NUEVA COLUMNA -->
                                <th class="p-2 font-semibold text-center">Acción</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            receiptItems.forEach((item, index) => {
                // NUEVO: Cálculo de Total Bs. por item
                const totalBsItem = formatCurrency((item.price * item.quantity) * bcvRate, 'VES');
                
                tableHtml += `
                    <tr class="border-t border-gray-200">
                        <td class="p-2 font-bold">${index + 1}</td>
                        <td class="p-2">${formatDateDDMMYY(item.serviceDate)}</td>
                        <td class="p-2">
                            <span class="font-bold block">${item.workerName}</span>
                            <span class="text-gray-600 block">${item.workerCi}</span>
                            ${item.patientName ? `<span class="text-purple-700 block text-xs">Paciente: ${item.patientName}</span>` : ''}
                        </td>
                        <td class="p-2">${item.description}</td>
                        <td class="p-2 text-center">${item.quantity}</td>
                        <td class="p-2 text-right">${formatCurrency(item.price, 'USD')}</td>
                        <td class="p-2 text-right font-bold">${formatCurrency(item.price * item.quantity, 'USD')}</td>
                        <!-- NUEVA CELDA -->
                        <td class="p-2 text-right font-bold text-purple-700">${totalBsItem}</td>
                        <!-- NUEVA CELDA -->
                        <td class="p-2 text-center">
                            <button class="delete-item-btn" data-id="${item.id}" title="Eliminar item">&times;</button>
                        </td>
                    </tr>
                `;
            });

            tableHtml += '</tbody></table></div>'; // Cerrar tabla y wrapper div
            receiptItemsContainer.innerHTML = tableHtml;
            renderTotals();
        };


        // --- MANEJADORES DE EVENTOS ---

        // Eventos de Modals (Abrir/Cerrar)
        manageEmittersBtn.addEventListener('click', () => emittersModal.classList.remove('hidden'));
        closeEmittersModalBtn.addEventListener('click', () => emittersModal.classList.add('hidden'));

        manageRecipientsBtn.addEventListener('click', () => recipientsModal.classList.remove('hidden'));
        closeRecipientsModalBtn.addEventListener('click', () => recipientsModal.classList.add('hidden'));

        manageWorkersBtn.addEventListener('click', () => workersModal.classList.remove('hidden'));
        closeWorkersModalBtn.addEventListener('click', () => workersModal.classList.add('hidden'));
        
        manageServicesBtn.addEventListener('click', () => servicesModal.classList.remove('hidden'));
        closeServicesModalBtn.addEventListener('click', () => servicesModal.classList.add('hidden'));

        // Eventos de Forms de Gestión (Submit)
        emitterForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const id = parseInt(emitterEditId.value);
            // ===== CAMBIO AQUÍ: Se eliminó toProperCase =====
            const name = emitterNameInput.value.trim();
            const rif = emitterRifInput.value.trim();
            const desc = emitterDescInput.value.trim();
            const useCorrelative = emitterCorrelativeInput.checked;

            if (id) { // Editando
                const index = emitters.findIndex(e => e.id === id);
                if (index !== -1) {
                    emitters[index] = { id, name, rif, desc, useCorrelative };
                }
            } else { // Creando
                const newId = emitters.length > 0 ? Math.max(...emitters.map(e => e.id)) + 1 : 1;
                emitters.push({ id: newId, name, rif, desc, useCorrelative });
            }
            
            saveToLocalStorage('medicalReceiptEmitters', emitters);
            renderEmittersList();
            emitterForm.reset();
            emitterEditId.value = '';
            emitterSubmitBtn.innerHTML = '<i class="fas fa-plus mr-2"></i> Añadir Emisor';
        });

        recipientForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const id = parseInt(recipientEditId.value);
            // ===== CAMBIO AQUÍ: Se eliminó toProperCase =====
            const name = recipientNameInput.value.trim();
            const rif = recipientRifInput.value.trim();
            const address = recipientAddressInput.value.trim();
            const phone = recipientPhoneInput.value.trim();

            if (id) { // Editando
                const index = recipients.findIndex(r => r.id === id);
                if (index !== -1) {
                    recipients[index] = { id, name, rif, address, phone };
                }
            } else { // Creando
                const newId = recipients.length > 0 ? Math.max(...recipients.map(r => r.id)) + 1 : 1;
                recipients.push({ id: newId, name, rif, address, phone });
            }
            
            saveToLocalStorage('medicalReceiptRecipients', recipients);
            renderRecipientsList();
            recipientForm.reset();
            recipientEditId.value = '';
            recipientSubmitBtn.innerHTML = '<i class="fas fa-plus mr-2"></i> Añadir Ente';
        });

        workerForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const id = parseInt(workerEditId.value);
            // (Se mantiene toProperCase para pacientes, según lo solicitado)
            const name = toProperCase(workerNameInput.value.trim());
            const ci = workerCiInput.value.trim();
            const familiar = toProperCase(workerFamiliarInput.value.trim());

            if (id) { // Editando
                const index = workers.findIndex(w => w.id === id);
                if (index !== -1) {
                    workers[index] = { id, name, ci, familiar };
                }
            } else { // Creando
                const newId = workers.length > 0 ? Math.max(...workers.map(w => w.id)) + 1 : 1;
                workers.push({ id: newId, name, ci, familiar });
            }
            
            saveToLocalStorage('medicalReceiptWorkers', workers);
            renderWorkersList();
            workerForm.reset();
            workerEditId.value = '';
            workerSubmitBtn.innerHTML = '<i class="fas fa-plus mr-2"></i> Añadir Paciente';
        });
        
        serviceForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const id = parseInt(serviceEditId.value);
            const description = serviceDescInput.value.trim();
            const total = parseFloat(servicePriceInput.value);
            const quantity = parseInt(serviceQuantityModalInput.value);
            
            if (isNaN(total) || isNaN(quantity) || quantity < 1 || total <= 0) {
                alert("Por favor, ingrese un precio y cantidad válidos."); // Reemplazar por modal si se desea
                return;
            }
            
            const price = total / quantity; // Calcular P/U

            if (id) { // Editando
                const index = services.findIndex(s => s.id === id);
                if (index !== -1) {
                    // MODIFICADO: Guardar también la cantidad por defecto
                    services[index] = { id, description, price, defaultQuantity: quantity };
                }
            } else { // Creando
                const newId = services.length > 0 ? Math.max(...services.map(s => s.id)) + 1 : 1;
                // MODIFICADO: Guardar también la cantidad por defecto
                services.push({ id: newId, description, price, defaultQuantity: quantity });
            }
            
            saveToLocalStorage('medicalReceiptServices', services);
            renderServicesList();
            serviceForm.reset();
            serviceEditId.value = '';
            serviceQuantityModalInput.value = '1';
            serviceSubmitBtn.innerHTML = '<i class="fas fa-plus mr-2"></i> Añadir';
        });

        // Eventos de Listas (Edit/Delete)
        emittersList.addEventListener('click', (e) => {
            const editBtn = e.target.closest('.edit-btn-list');
            const deleteBtn = e.target.closest('.delete-btn-list');
            
            if (editBtn) {
                const id = parseInt(editBtn.dataset.id);
                const emitter = emitters.find(e => e.id === id);
                if (emitter) {
                    emitterEditId.value = emitter.id;
                    emitterNameInput.value = emitter.name;
                    emitterRifInput.value = emitter.rif;
                    emitterDescInput.value = emitter.desc;
                    emitterCorrelativeInput.checked = emitter.useCorrelative;
                    emitterSubmitBtn.innerHTML = '<i class="fas fa-save mr-2"></i> Guardar Cambios';
                }
            }
            if (deleteBtn) {
                const id = parseInt(deleteBtn.dataset.id);
                emitters = emitters.filter(e => e.id !== id);
                saveToLocalStorage('medicalReceiptEmitters', emitters);
                renderEmittersList();
            }
        });

        recipientsList.addEventListener('click', (e) => {
            const editBtn = e.target.closest('.edit-btn-list');
            const deleteBtn = e.target.closest('.delete-btn-list');
            
            if (editBtn) {
                const id = parseInt(editBtn.dataset.id);
                const recipient = recipients.find(r => r.id === id);
                if (recipient) {
                    recipientEditId.value = recipient.id;
                    recipientNameInput.value = recipient.name;
                    recipientRifInput.value = recipient.rif;
                    recipientAddressInput.value = recipient.address;
                    recipientPhoneInput.value = recipient.phone;
                    recipientSubmitBtn.innerHTML = '<i class="fas fa-save mr-2"></i> Guardar Cambios';
                }
            }
            if (deleteBtn) {
                const id = parseInt(deleteBtn.dataset.id);
                recipients = recipients.filter(r => r.id !== id);
                saveToLocalStorage('medicalReceiptRecipients', recipients);
                renderRecipientsList();
            }
        });
        
        workersList.addEventListener('click', (e) => {
            const editBtn = e.target.closest('.edit-btn-list');
            const deleteBtn = e.target.closest('.delete-btn-list');
            
            if (editBtn) {
                const id = parseInt(editBtn.dataset.id);
                const worker = workers.find(w => w.id === id);
                if (worker) {
                    workerEditId.value = worker.id;
                    workerNameInput.value = worker.name;
                    workerCiInput.value = worker.ci;
                    workerFamiliarInput.value = worker.familiar;
                    workerSubmitBtn.innerHTML = '<i class="fas fa-save mr-2"></i> Guardar Cambios';
                }
            }
            if (deleteBtn) {
                const id = parseInt(deleteBtn.dataset.id);
                workers = workers.filter(w => w.id !== id);
                saveToLocalStorage('medicalReceiptWorkers', workers);
                renderWorkersList();
            }
        });
        
        servicesList.addEventListener('click', (e) => {
            const editBtn = e.target.closest('.edit-btn-list');
            const deleteBtn = e.target.closest('.delete-btn-list');
            
            if (editBtn) {
                const id = parseInt(editBtn.dataset.id);
                const service = services.find(s => s.id === id);
                if (service) {
                    serviceEditId.value = service.id;
                    // MODIFICADO: Cargar la cantidad por defecto y calcular el precio total
                    const defaultQty = service.defaultQuantity || 1;
                    serviceDescInput.value = service.description;
                    // Calcular total price = P/U * defaultQty
                    servicePriceInput.value = (service.price * defaultQty).toFixed(2);
                    serviceQuantityModalInput.value = defaultQty;
                    serviceSubmitBtn.innerHTML = '<i class="fas fa-save mr-2"></i> Guardar Cambios';
                }
            }
            if (deleteBtn) {
                const id = parseInt(deleteBtn.dataset.id);
                services = services.filter(s => s.id !== id);
                saveToLocalStorage('medicalReceiptServices', services);
                renderServicesList();
            }
        });


        // Eventos del Form Principal (Añadir a Recibo)
        addItemForm.addEventListener('submit', (e) => {
            e.preventDefault();
            
            const workerId = findIdFromDatalistInput(workerInput, workerOptions);
            const serviceId = findIdFromDatalistInput(serviceInput, serviceOptions);
            const quantity = parseInt(serviceQuantityInput.value);
            const serviceDate = serviceDateInput.value;
            
            const worker = workers.find(w => w.id === workerId);
            const service = services.find(s => s.id === serviceId);
            
            if (!worker || !service || isNaN(quantity) || quantity < 1 || !serviceDate) {
                console.warn("Datos incompletos para añadir item.");
                return;
            }
            
            // (Se mantiene toProperCase para pacientes)
            const patientName = toProperCase(patientNameInput.value.trim() || worker.familiar);

            receiptItems.push({
                id: Date.now(), // ID simple para el item del recibo
                workerName: worker.name,
                workerCi: worker.ci,
                patientName: patientName,
                serviceDate: serviceDate,
                description: service.description,
                price: service.price,
                quantity: quantity
            });
            
            renderReceiptPreview();
            
            // Limpiar campos del formulario
            workerInput.value = '';
            workerSelectId.value = '';
            patientNameInput.value = '';
            serviceInput.value = '';
            serviceSelectId.value = '';
            serviceQuantityInput.value = '1';
            servicePriceDisplay.textContent = '$0.00';
            serviceDateInput.value = receiptDateInput.value || new Date().toISOString().split('T')[0];
        });

        // ==================================================================
        // ===== NUEVO EVENT LISTENER: Eliminar item del recibo =====
        // ==================================================================
        receiptItemsContainer.addEventListener('click', (e) => {
            const deleteBtn = e.target.closest('.delete-item-btn');
            if (deleteBtn) {
                const idToDelete = parseInt(deleteBtn.dataset.id);
                receiptItems = receiptItems.filter(item => item.id !== idToDelete);
                renderReceiptPreview(); // Re-renderizar la tabla y los totales
            }
        });


        // Eventos Generales (Inputs que afectan la UI)
        bcvRateInput.addEventListener('input', () => {
            bcvRate = parseFloat(bcvRateInput.value) || 0.0;
            // NUEVO: Re-renderizar la tabla completa para actualizar Total (Bs.) de cada item
            renderReceiptPreview();
        });
        
        receiptDateInput.addEventListener('input', () => {
            const date = new Date(receiptDateInput.value + 'T00:00:00-04:00'); // Ajustar a zona horaria Vzla
            previewDate.textContent = date.toLocaleDateString('es-VE', { timeZone: 'America/Caracas' });
            if (!serviceDateInput.value) {
                serviceDateInput.value = receiptDateInput.value;
            }
        });

        emitterInput.addEventListener('input', () => {
            const id = findIdFromDatalistInput(emitterInput, emitterOptions);
            if (id) {
                const emitter = emitters.find(e => e.id === id);
                previewEmitterName.textContent = emitter.name;
                previewEmitterRif.textContent = emitter.rif;
                previewEmitterDesc.textContent = emitter.desc;
                emitterSelectId.value = emitter.id;
                
                if (emitter.useCorrelative) {
                    receiptNumberInput.value = String(nextReceiptNumber).padStart(3, '0');
                    receiptNumberInput.disabled = true;
                    receiptNumberInput.dispatchEvent(new Event('input'));
                } else {
                    receiptNumberInput.disabled = false;
                }
            } else {
                previewEmitterName.textContent = 'Nombre del Emisor';
                previewEmitterRif.textContent = '';
                previewEmitterDesc.textContent = 'Descripción';
                emitterSelectId.value = '';
                receiptNumberInput.disabled = false;
            }
        });
        
        recipientInput.addEventListener('input', () => {
            const id = findIdFromDatalistInput(recipientInput, recipientOptions);
            if (id) {
                const r = recipients.find(r => r.id === id);
                previewRecipientName.textContent = r.name;
                previewRecipientRif.textContent = r.rif;
                previewRecipientAddress.textContent = r.address;
                previewRecipientPhone.textContent = r.phone;
                recipientSelectId.value = r.id;
            } else {
                previewRecipientName.textContent = 'Seleccione un ente receptor';
                previewRecipientRif.textContent = '';
                previewRecipientAddress.textContent = '';
                previewRecipientPhone.textContent = '';
                recipientSelectId.value = '';
            }
        });
        
        workerInput.addEventListener('input', () => {
             const id = findIdFromDatalistInput(workerInput, workerOptions);
             if (id) {
                 const worker = workers.find(w => w.id === id);
                 if (worker && worker.familiar) {
                     patientNameInput.value = worker.familiar;
                 }
                 workerSelectId.value = worker.id;
             } else {
                 patientNameInput.value = '';
                 workerSelectId.value = '';
             }
        });
        
        serviceInput.addEventListener('input', () => {
             const id = findIdFromDatalistInput(serviceInput, serviceOptions);
             if (id) {
                 const service = services.find(s => s.id === id);
                 servicePriceDisplay.textContent = `$${formatCurrency(service.price, 'USD')}`;
                 serviceSelectId.value = service.id;
                 // NUEVO: Asignar cantidad por defecto del servicio
                 serviceQuantityInput.value = service.defaultQuantity || 1;
             } else {
                 servicePriceDisplay.textContent = '$0.00';
                 serviceSelectId.value = '';
                 // NUEVO: Resetear cantidad a 1
                 serviceQuantityInput.value = 1;
             }
        });
        
        emitterRifInput.addEventListener('input', (e) => {
            e.target.value = formatRIF(e.target.value);
        });
        
        recipientRifInput.addEventListener('input', (e) => {
            e.target.value = formatRIF(e.target.value);
        });
        
        workerCiInput.addEventListener('input', (e) => {
            e.target.value = formatCI(e.target.value);
        });
        
        receiptNumberInput.addEventListener('input', () => {
            const num = receiptNumberInput.value.trim();
            if (num) {
                previewReceiptNumberWrapper.style.display = 'block';
                previewReceiptNumber.textContent = num;
            } else {
                previewReceiptNumberWrapper.style.display = 'none';
                previewReceiptNumber.textContent = 'N/A';
            }
        });
        
        // ==================================================================
        // ===== LÓGICA DE DESCARGA PDF CON JSPD (SIN CAMBIOS) =====
        // ==================================================================
        
        downloadPdfButton.addEventListener('click', () => {
            const originalButtonHtml = downloadPdfButton.innerHTML;
            
            downloadPdfButton.disabled = true;
            downloadPdfButton.innerHTML = `
                <i class="fas fa-spinner fa-spin mr-2"></i> Generando PDF...
            `;
            
            try {
                // 1. Inicialización de jsPDF
                const doc = new window.jspdf.jsPDF('p', 'mm', 'a4');
                
                const margin = 15;
                let yPos = margin;
                const pageWidth = doc.internal.pageSize.getWidth();
                const usableWidth = pageWidth - (margin * 2);

                // --- 2. Encabezado (Emisor e Info de Recibo) ---
                
                const emitterName = previewEmitterName.textContent.trim();
                const emitterRif = previewEmitterRif.textContent.trim();
                const emitterDesc = previewEmitterDesc.textContent.trim();
                const date = previewDate.textContent.trim();
                const receiptNumber = previewReceiptNumberWrapper.style.display !== 'none' 
                                      ? previewReceiptNumber.textContent.trim() 
                                      : null;

                doc.setFont('Helvetica', 'bold');
                doc.setFontSize(16);
                doc.setTextColor(76, 29, 149); // purple-900
                doc.text(emitterName, margin, yPos);
                
                doc.setFont('Helvetica', 'normal');
                doc.setFontSize(10);
                doc.setTextColor(0, 0, 0);
                doc.text(`Fecha: ${date}`, pageWidth - margin, yPos, { align: 'right' });
                yPos += 5;
                
                doc.setFont('Helvetica', 'normal');
                doc.setFontSize(10);
                doc.setTextColor(107, 33, 168); // purple-700
                
                if (emitterRif) {
                    doc.text(emitterRif, margin, yPos);
                    yPos += 5;
                }
                doc.text(emitterDesc, margin, yPos);
                
                doc.setTextColor(0, 0, 0);
                if (receiptNumber) {
                    doc.text(`Recibo N°: ${receiptNumber}`, pageWidth - margin, yPos, { align: 'right' });
                }
                
                yPos += 10;
                doc.setDrawColor(229, 231, 235); // gray-200
                doc.line(margin, yPos, pageWidth - margin, yPos);
                yPos += 10;

                // --- 3. Información del Receptor ---
                const recipientName = previewRecipientName.textContent.trim();
                const rif = previewRecipientRif.textContent.trim();
                const address = previewRecipientAddress.textContent.trim();
                const phone = previewRecipientPhone.textContent.trim();

                doc.setFont('Helvetica', 'bold');
                doc.setFontSize(11);
                doc.text(recipientName, margin, yPos);
                yPos += 5;
                
                doc.setFont('Helvetica', 'normal');
                doc.setFontSize(10);
                if (rif) doc.text(rif, margin, yPos);
                yPos += 5;
                
                const addressLines = doc.splitTextToSize(address, usableWidth * 0.75);
                doc.text(addressLines, margin, yPos);
                yPos += (addressLines.length * 4) + 2;
                
                if (phone) doc.text(phone, margin, yPos);
                yPos += 15;

                // --- 4. Título de la Tabla ---
                doc.setFont('Helvetica', 'bold');
                doc.setFontSize(14);
                doc.setTextColor(67, 56, 202); // purple-800
                doc.text("Servicios Médicos", margin, yPos);
                yPos += 8;

                // --- 5. Tabla de Items (jsPDF-AutoTable) ---
                
                const tableHead = [
                    ['N°', 'Fecha', 'Nombres/C.I/Paciente', 'Servicio', 'Cant.', 'P/U ($)', 'Total ($)', 'Total (Bs.)']
                ];

                const tableBody = receiptItems.map((item, index) => {
                    const formattedDate = formatDateDDMMYY(item.serviceDate);
                    const patientInfo = `${item.workerName}\n${item.workerCi}${item.patientName ? `\nPaciente: ${item.patientName}` : ''}`;
                    const unitPrice = formatCurrency(item.price, 'PDF_USD');
                    const totalUSD = formatCurrency(item.quantity * item.price, 'PDF_USD');
                    const totalBS = formatCurrency((item.quantity * item.price) * bcvRate, 'VES');
                    
                    return [
                        index + 1,
                        formattedDate,
                        patientInfo,
                        item.description,
                        item.quantity,
                        unitPrice,
                        totalUSD,
                        totalBS
                    ];
                });

                doc.autoTable({
                    startY: yPos,
                    head: tableHead,
                    body: tableBody,
                    theme: 'plain',
                    headStyles: {
                        fillColor: [245, 243, 255], // purple-50
                        textColor: [88, 28, 135], // purple-900
                        fontStyle: 'bold',
                        lineColor: [221, 214, 254], // purple-200
                        lineWidth: 0.1
                    },
                    styles: {
                        font: 'Helvetica',
                        fontSize: 8,
                        cellPadding: 2.5,
                        valign: 'middle',
                        lineWidth: 0.1,
                        lineColor: [229, 231, 235] // gray-200
                    },
                    columnStyles: {
                        0: { cellWidth: 8, halign: 'center' }, // N°
                        1: { cellWidth: 20 }, // Fecha
                        2: { cellWidth: 'auto' }, // Nombres
                        3: { cellWidth: 28 }, // Servicio
                        4: { cellWidth: 10, halign: 'center' }, // Cant.
                        5: { cellWidth: 20, halign: 'right' }, // P/U
                        6: { cellWidth: 20, halign: 'right' }, // Total $
                        7: { cellWidth: 25, halign: 'right' }  // Total Bs.
                    },
                    willDrawCell: (data) => {
                        if (data.section === 'body') {
                            if (data.column.index === 0 || data.column.index === 2 || data.column.index === 6) {
                                data.cell.styles.fontStyle = 'bold';
                            } else {
                                data.cell.styles.fontStyle = 'normal';
                            }
                        }
                    },
                    didDrawPage: (data) => {
                        yPos = data.cursor.y;
                    }
                });
 
                // --- 6. Totales (con recuadro) ---
                yPos += 8;

                const subtotal = subtotalUsd.textContent;
                const bcv = previewBcvRate.textContent;
                const total = totalBs.textContent;
                
                const rectX = pageWidth / 2 - 10;
                const rectY = yPos;
                const rectWidth = (pageWidth - margin) - rectX;
                const rectHeight = 26;
                const borderRadius = 3;
                
                doc.setFillColor(245, 243, 255); // purple-50
                doc.roundedRect(rectX, rectY, rectWidth, rectHeight, borderRadius, borderRadius, 'F');

                let textY = rectY + 7;
                const labelX = rectX + 5;
                const valueX = rectX + rectWidth - 5;

                doc.setFont('Helvetica', 'bold');
                doc.setFontSize(10);
                doc.setTextColor(0, 0, 0);
                doc.text('Subtotal ($)', labelX, textY);
                doc.setFont('Helvetica', 'normal');
                doc.text(subtotal, valueX, textY, { align: 'right' });
                textY += 6;

                doc.setFont('Helvetica', 'bold');
                doc.setTextColor(107, 33, 168); // purple-700
                doc.text('Tasa BCV', labelX, textY);
                doc.setFont('Helvetica', 'normal');
                doc.text(`Bs. ${bcv}`, valueX, textY, { align: 'right' });
                textY += 5;

                doc.setDrawColor(221, 214, 254); // purple-200
                doc.setLineWidth(0.5);
                doc.line(rectX + 2, textY, rectX + rectWidth - 2, textY);
                textY += 6;

                doc.setFont('Helvetica', 'bold');
                doc.setFontSize(11);
                doc.setTextColor(67, 56, 202); // purple-800
                doc.text('TOTAL (Bs.)', labelX, textY);
                doc.text(total, valueX, textY, { align: 'right' });

                // --- 7. Pie de Página ---
                yPos = doc.internal.pageSize.getHeight() - 15;
                doc.setFont('Helvetica', 'normal');
                doc.setFontSize(8);
                doc.setTextColor(156, 163, 175); // gray-400
                doc.text('Gracias por su confianza.', pageWidth / 2, yPos, { align: 'center' });
                yPos += 4;
                doc.text('Este es un recibo informativo, no es una factura fiscal.', pageWidth / 2, yPos, { align: 'center' });

                // --- 8. Guardar el PDF ---
                const receiptNumberForFile = receiptNumber || 'S-N';
                const receiptDateForFile = date.replace(/\//g, '-');
                const fileName = `Recibo-${receiptNumberForFile}_${receiptDateForFile}.pdf`;
                
                doc.save(fileName);
                
                // --- 9. Lógica de Correlativo ---
                const selectedEmitterId = parseInt(emitterSelectId.value);
                const selectedEmitter = emitters.find(e => e.id === selectedEmitterId);
                
                if (selectedEmitter && selectedEmitter.useCorrelative) {
                    const numberUsed = parseInt(receiptNumberInput.value);
                    nextReceiptNumber = numberUsed + 1;
                    localStorage.setItem('receiptCorrelative', JSON.stringify(nextReceiptNumber));
                    
                    receiptNumberInput.value = String(nextReceiptNumber).padStart(3, '0');
                    receiptNumberInput.dispatchEvent(new Event('input'));
                }

                // --- 10. Resetear el botón ---
                downloadPdfButton.disabled = false;
                downloadPdfButton.innerHTML = originalButtonHtml;

            } catch (error) {
                console.error("Error al generar PDF con jsPDF: ", error);
                downloadPdfButton.disabled = false;
                downloadPdfButton.innerHTML = originalButtonHtml;
            }
        });

        // ==================================================================
        // ===== FIN DE LA LÓGICA DE DESCARGA PDF ===========================
        // ==================================================================


        // Eventos del botón de Limpiar
        resetButton.addEventListener('click', () => {
            resetModal.classList.remove('hidden');
        });
        cancelResetBtn.addEventListener('click', () => {
            resetModal.classList.add('hidden');
        });
        confirmResetBtn.addEventListener('click', () => {
            receiptItems = [];
            renderReceiptPreview();
            resetModal.classList.add('hidden');
        });
        
        // --- INICIALIZACIÓN ---
        const today = new Date().toISOString().split('T')[0];
        receiptDateInput.value = today;
        serviceDateInput.value = today; 
        previewDate.textContent = new Date().toLocaleDateString('es-VE', { timeZone: 'America/Caracas' });
        receiptNumberInput.dispatchEvent(new Event('input')); 

        // Renderizar todo al cargar
        renderEmittersList();
        renderRecipientsList();
        renderWorkersList();
        renderServicesList();
        renderReceiptPreview();
    });
    </script>
</body>
</html>

