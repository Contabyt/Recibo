<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generador de Recibos Médicos</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Iconos Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- jsPDF and html2canvas for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* FONDO DEL FORMULARIO CAMBIADO A GRIS CLARO (bg-gray-50) */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f9fafb; /* gray-50 */
        }
        .container-wrapper {
             /* Wrapper para mantener el color de fondo consistente */
             background-color: #f9fafb;
        }
        
        /* --- BLOQUE DE CÓDIGO ELIMINADO ---
           Se eliminó el bloque de estilos de fuente en 'pt' 
           que estaba causando conflictos con html2canvas.
           Ahora, la captura del PDF usará los estilos de Tailwind 
           de la vista previa, que son correctos.
        */


        @media print {
            body * {
                visibility: hidden;
            }
            #receipt-preview, #receipt-preview * {
                visibility: visible;
            }
            #receipt-preview {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
            }
            .no-print {
                display: none;
            }
        }
        
        /* Botones de lista con iconos */
        .list-btn {
            border-radius: 50%;
            width: 28px;
            height: 28px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            font-size: 0.8rem; 
            cursor: pointer;
        }
        .delete-btn-list {
             background: #fef2f2; /* red-50 */
             color: #ef4444; /* red-500 */
             border: 1px solid #fecaca; /* red-200 */
        }
        .delete-btn-list:hover {
            background: #ef4444; /* red-500 */
            color: white;
        }
        .edit-btn-list {
            background: #faf5ff; /* purple-50 */
            color: #9333ea; /* purple-600 */
            border: 1px solid #e9d5ff; /* purple-200 */
            margin-right: 8px;
        }
        .edit-btn-list:hover {
            background: #9333ea; /* purple-600 */
            color: white;
        }
        
        /* --- ELIMINADO ---
         Ocultar flechas en input number 
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { 
          -webkit-appearance: none; 
          margin: 0; 
        }
        input[type=number] {
          -moz-appearance: textfield;
        }
        */

        /* --- INICIO DE CORRECCIÓN DE PDF --- */
        /* Reducir padding y tamaños de fuente para que el PDF se genere más compacto */
        #receipt-preview {
            padding: 1.25rem; /* p-5, más pequeño que p-8 */
        }
        /* Estos estilos anulan las clases de Tailwind dentro de la vista previa para el renderizado */
        #receipt-preview header h2 { font-size: 1rem; } /* text-base */
        #receipt-preview header p { font-size: 0.875rem; } /* text-sm */
        #receipt-preview header .text-right { font-size: 0.875rem; } /* text-sm */
        
        #preview-recipient-info { 
            font-size: 8pt; /* text-xs, 12px. Usar pt para consistencia de PDF */
            line-height: 1.3;
            margin-top: 0.75rem; 
            margin-bottom: 0.75rem; 
        }
        #preview-recipient-name { 
            font-size: 9pt; 
            font-weight: 600; 
        } 
        
        #receipt-preview h3.text-xl { /* Título "Servicios Médicos" */
            font-size: 1.125rem; /* text-lg */
            margin-top: 1rem;
            margin-bottom: 0.5rem;
        }

        /* Reducir el tamaño de fuente de la tabla (muy importante) */
        #receipt-items-container table {
            font-size: 8pt; /* Usar 'pt' es más consistente para PDF */
            line-height: 1.2;
        }
        #receipt-items-container table th,
        #receipt-items-container table td {
            padding: 3px 4px; /* Padding de celdas más pequeño */
        }
        
        /* Reducir espacio y tamaño en Totales */
        #receipt-preview section.mt-8 { 
            margin-top: 1rem; /* Menos espacio arriba de los totales */
        }
        #receipt-preview .bg-purple-50 { 
            padding: 0.75rem; /* p-3 */
        }
        #receipt-preview .bg-purple-50 .text-base { font-size: 9pt; }
        #receipt-preview .bg-purple-50 .text-xl { font-size: 10pt; font-weight: 700; }
        
        /* Pie de página */
        #receipt-preview footer.mt-12 {
            margin-top: 1.5rem; /* mt-6 */
            font-size: 7pt; /* Muy pequeño, como en los recibos de referencia */
        }
        /* --- FIN DE CORRECCIÓN DE PDF --- */

    </style>
</head>
<body class="text-purple-900 container-wrapper">

    <div class="container mx-auto p-4 lg:p-8">
        <header class="text-center mb-8 no-print">
            <h1 class="text-4xl font-bold text-fuchsia-600">Generador de Recibos</h1>
            <!-- PÁRRAFO ELIMINADO -->
            <!-- <p class="text-purple-700 mt-2">Completa los campos para crear una pre-factura detallada.</p> -->
        </header>

        <!-- CORRECCIÓN: Ajuste de la rejilla para que los anchos sean iguales (50/50) -->
        <main class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <!-- Columna de Controles (ahora 1/2 parte) -->
            <div class="bg-white p-6 rounded-2xl shadow-lg no-print space-y-8 lg:col-span-1">
                <!-- Información General -->
                <div>
                    <h2 class="text-2xl font-bold mb-6 border-b pb-3 text-purple-800">Información General</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <!-- CAMPO EMISOR (DATALIST) -->
                        <div>
                            <label for="emitter-input" class="block text-sm font-medium text-gray-900 mb-1">Emisor (DE:)</label>
                            <input list="emitter-options" id="emitter-input" placeholder="Escriba para buscar o seleccionar..." class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-purple-500 text-gray-800" required>
                            <datalist id="emitter-options"></datalist>
                            <input type="hidden" id="emitter-select-id">
                        </div>
                        <!-- CAMPO RECEPTOR (DATALIST) -->
                        <div>
                            <label for="recipient-input" class="block text-sm font-medium text-gray-900 mb-1">Ente Receptor (PARA:)</label>
                            <input list="recipient-options" id="recipient-input" placeholder="Escriba para buscar o seleccionar..." class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-purple-500 text-gray-800" required>
                            <datalist id="recipient-options"></datalist>
                            <input type="hidden" id="recipient-select-id">
                        </div>
                        <div>
                            <label for="receipt-date" class="block text-sm font-medium text-gray-900 mb-1">Fecha del Recibo</label>
                            <input type="date" id="receipt-date" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition text-gray-800">
                        </div>
                        <div>
                            <label for="bcv-rate" class="block text-sm font-medium text-gray-900 mb-1">Tasa BCV (Bs. por $)</label>
                            <input type="number" id="bcv-rate" placeholder="Ej: 36.50" step="0.00001" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition text-gray-800">
                        </div>
                        <div>
                            <label for="receipt-number-input" class="block text-sm font-medium text-gray-900 mb-1">N° Recibo (Opcional)</label>
                            <!-- AÑADIDO: disabled:bg-gray-100 para correlativo -->
                            <input type="text" id="receipt-number-input" placeholder="Ej: 002" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition text-gray-800 disabled:bg-gray-100">
                        </div>
                    </div>
                </div>

                <!-- Añadir Servicio al Recibo -->
                <div>
                    <h2 class="text-2xl font-bold mb-4 border-b pb-3 text-purple-800">Añadir al Recibo</h2>
                    <form id="add-item-form" class="space-y-4">
                        <!-- CAMPO TRABAJADOR (DATALIST) -->
                        <div>
                            <!-- CAMBIO DE TEXTO: Trabajador -> Nombres -->
                            <label for="worker-input" class="block text-sm font-medium text-gray-900 mb-1">Nombres</label>
                            <input list="worker-options" id="worker-input" placeholder="Escriba para buscar o seleccionar..." class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-purple-500 text-gray-800" required>
                            <datalist id="worker-options"></datalist>
                            <input type="hidden" id="worker-select-id">
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="patient-name" class="block text-sm font-medium text-gray-900 mb-1">Nombre del Paciente (Familiar)</label>
                                <!-- NOTE: Este campo se llena automáticamente si el trabajador tiene familiar asociado -->
                                <input type="text" id="patient-name" placeholder="(Opcional, se usa el familiar por defecto)" class="w-full p-2 border border-gray-300 rounded-md text-gray-800">
                            </div>
                            <!-- CAMPO NUEVO: Fecha del Servicio -->
                            <div>
                                <label for="service-date" class="block text-sm font-medium text-gray-900 mb-1">Fecha del Servicio</label>
                                <input type="date" id="service-date" class="w-full p-2 border border-gray-300 rounded-md text-gray-800" required>
                            </div>
                        </div>

                        <!-- CAMPO SERVICIO (DATALIST) -->
                        <div>
                            <label for="service-input" class="block text-sm font-medium text-gray-900 mb-1">Servicio</LAbel>
                            <input list="service-options" id="service-input" placeholder="Escriba para buscar o seleccionar..." class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-purple-500 text-gray-800" required>
                            <datalist id="service-options"></datalist>
                            <input type="hidden" id="service-select-id">
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                             <div>
                                <label for="service-quantity" class="block text-sm font-medium text-gray-900 mb-1">Cantidad</p>
                                <input type="number" id="service-quantity" value="1" min="1" class="w-full p-2 border border-gray-300 rounded-md text-gray-800" required>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-900 mb-1">Precio Unit. ($)</label>
                                <p id="service-price-display" class="w-full p-2 bg-gray-100 rounded-md text-gray-500">$0.00</p>
                            </div>
                        </div>
                        <!-- BOTÓN AGREGAR (NUEVO ESTILO) -->
                        <button type="submit" class="w-full bg-purple-200 text-purple-900 font-bold py-3 px-6 rounded-full hover:bg-purple-300 transition duration-300 flex items-center justify-center shadow-lg shadow-purple-200/50">
                            <i class="fas fa-plus mr-2"></i> Agregar al Recibo
                        </button>
                    </form>
                </div>
                
                 <!-- Gestión de Catálogos -->
                <div class="space-y-4 pt-4">
                    <h2 class="text-2xl font-bold mb-4 border-b pb-3 text-purple-800">Gestión de Catálogos</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <button id="manage-emitters-btn" class="w-full bg-purple-100 hover:bg-purple-200 text-purple-800 font-bold py-3 px-4 rounded-md flex items-center justify-center">
                            <i class="fas fa-user-tie mr-2"></i> Gestionar Emisores
                        </button>
                        <button id="manage-recipients-btn" class="w-full bg-purple-100 hover:bg-purple-200 text-purple-800 font-bold py-3 px-4 rounded-md flex items-center justify-center">
                            <i class="fas fa-building mr-2"></i> Gestionar Entes
                        </button>
                        <!-- CAMBIO DE TEXTO: Gestionar Trabajadores -> Gestionar Pacientes -->
                        <button id="manage-workers-btn" class="w-full bg-purple-100 hover:bg-purple-200 text-purple-800 font-bold py-3 px-4 rounded-md flex items-center justify-center">
                            <i class="fas fa-users mr-2"></i> Gestionar Pacientes
                        </button>
                        <button id="manage-services-btn" class="w-full bg-purple-100 hover:bg-purple-200 text-purple-800 font-bold py-3 px-4 rounded-md flex items-center justify-center">
                            <i class="fas fa-stethoscope mr-2"></i> Gestionar Servicios
                        </button>
                    </div>
                </div>

            </div>

            <!-- Columna de Vista Previa (ahora 1/2 parte) -->
            <div class="lg:col-span-1">
                <!-- AJUSTE DE TAMAÑOS DE FUENTE EN EL RECIBO (Anulados por CSS en <style>) -->
                <div id="receipt-preview" class="bg-white p-8 rounded-2xl shadow-lg min-h-full text-gray-800">
                    <header class="flex justify-between items-start pb-4 border-b-2 border-gray-200">
                        <div>
                            <h2 id="preview-emitter-name" class="text-lg font-bold text-purple-900">Nombre del Emisor</h2>
                            <p id="preview-emitter-desc" class="text-purple-700 text-sm">Descripción</p>
                        </div>
                        <div class="text-right text-sm text-gray-500">
                            <p class="font-semibold">Fecha: <span id="preview-date">--/--/----</span></p>
                            <!-- CAMPO DE N° RECIBO CONDICIONAL -->
                            <p id="preview-receipt-number-wrapper" style="display: none;">Recibo N°: <span id="preview-receipt-number">N/A</span></p>
                        </div>
                    </header>
                    
                    <section id="preview-recipient-info" class="my-6 text-sm">
                        <div>
                            <!-- <h3 class="font-semibold text-purple-700 uppercase tracking-wider mb-2">PARA:</h3> --> <!-- ELIMINADO -->
                            <p id="preview-recipient-name" class="font-semibold text-base">Seleccione un ente receptor</p>
                            <p id="preview-recipient-rif" class="text-gray-600"></p>
                            <p id="preview-recipient-address" class="text-gray-600"></p>
                            <p id="preview-recipient-phone" class="text-gray-600"></p>
                        </div>
                    </section>

                    <!-- TÍTULO AÑADIDO (COMO PDF) -->
                    <h3 class="text-xl font-bold text-purple-800 mt-6 mb-4">Servicios Médicos</h3>

                    <!-- SECCIÓN DE ITEMS REESTRUCTURADA (AHORA ES UNA SOLA TABLA) -->
                    <section id="receipt-items-container">
                        <!-- Items del recibo se renderizan aquí como una sola tabla -->
                         <p class="text-center text-gray-500 py-10">Aún no se han agregado items al recibo.</p>
                    </section>

                    <section class="mt-8 flex justify-end">
                        <div class="w-full md:w-1/2 lg:w-2/3">
                            <!-- AJUSTE DE TAMAÑOS DE FUENTE EN TOTALES (Anulados por CSS en <style>) -->
                            <div class="bg-purple-50 p-4 rounded-lg space-y-2">
                                <div class="flex justify-between text-base font-semibold">
                                    <span>Subtotal ($)</span>
                                    <span id="subtotal-usd">$0.00</span>
                                </div>
                                <div class="flex justify-between text-base text-purple-700">
                                    <span>Tasa BCV</span>
                                    <span>Bs. <span id="preview-bcv-rate">0.00</span></span>
                                </div>
                                <hr>
                                <div class="flex justify-between text-xl font-bold text-purple-900 pt-2">
                                    <span>TOTAL (Bs.)</span>
                                    <span id="total-bs">Bs. 0.00</span>
                                </div>
                            </div>
                        </div>
                    </section>
                    
                    <footer class="text-center mt-12 text-xs text-gray-400">
                        <p>Gracias por su confianza.</p>
                        <p>Este es un recibo informativo, no es una factura fiscal.</p>
                    </footer>
                </div>
                 <div class="text-center mt-6 no-print">
                    <!-- BOTÓN DESCARGAR PDF (MODIFICADO) -->
                    <button id="download-pdf-button" class="bg-green-200 text-green-900 font-bold py-3 px-8 rounded-full hover:bg-green-300 transition duration-300 flex items-center justify-center mx-auto mb-2 w-full md:w-auto md:inline-flex shadow-lg shadow-green-200/50">
                        <i class="fas fa-file-pdf mr-2"></i> Descargar PDF
                    </button>
                    <!-- BOTÓN LIMPIAR (ACTUALIZADO AL ESTILO DE LA IMAGEN) -->
                    <button id="reset-button" class="bg-yellow-200 text-yellow-900 font-bold py-3 px-8 rounded-full hover:bg-yellow-300 transition duration-300 md:ml-2 flex items-center justify-center mx-auto w-full md:w-auto md:inline-flex shadow-lg shadow-yellow-200/50">
                        <i class="fas fa-arrow-left mr-2"></i> Limpiar Formulario
                    </button>
                </div>
            </div>
        </main>
    </div>

    <!-- ===== MODALS ===== -->

    <!-- Custom Modal for Reset Confirmation -->
    <div id="reset-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center no-print hidden z-50 p-4">
        <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-sm text-gray-800">
            <h3 class="text-lg font-semibold mb-4">Confirmar Acción</h3>
            <p class="text-gray-600 mb-6">¿Estás seguro de que quieres limpiar todo el recibo?</p>
            <div class="flex justify-end gap-4">
                <button id="cancel-reset-btn" class="py-2 px-4 bg-purple-100 text-purple-800 rounded-md hover:bg-purple-200 flex items-center">
                    <i class="fas fa-times mr-2"></i>Cancelar
                </button>
                <button id="confirm-reset-btn" class="py-2 px-4 bg-red-600 text-white rounded-md hover:bg-red-700 flex items-center">
                    <i class="fas fa-check mr-2"></i>Confirmar
                </button>
            </div>
        </div>
    </div>
    
    <!-- Emitters Modal -->
    <div id="emitters-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center no-print hidden z-50 p-4">
        <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-2xl text-gray-800">
            <div class="flex justify-between items-center mb-4 border-b pb-2">
                <h3 class="text-2xl font-bold text-purple-800">Gestionar Emisores</h3>
                <button id="close-emitters-modal-btn" class="text-gray-400 hover:text-gray-600 text-2xl">&times;</button>
            </div>
            <!-- Form -->
            <form id="emitter-form" class="space-y-4 mb-4"> <!-- Aumentado space-y -->
                <input type="hidden" id="emitter-edit-id">
                <input type="text" id="emitter-name-input" placeholder="Nombre del Emisor (Ej: Dra. ...)" class="w-full p-2 border rounded-md text-gray-800" required>
                <input type="text" id="emitter-desc-input" placeholder="Descripción (Ej: Ginecólogo)" class="w-full p-2 border rounded-md text-gray-800" required>
                
                <!-- CHECKBOX CORRELATIVO AÑADIDO -->
                <div class="flex items-center">
                    <input type="checkbox" id="emitter-correlative-input" class="h-4 w-4 text-purple-600 border-gray-300 rounded focus:ring-purple-500">
                    <label for="emitter-correlative-input" class="ml-2 block text-sm text-gray-900">Usar correlativo de recibo</label>
                </div>

                <button type="submit" id="emitter-submit-btn" class="w-full bg-purple-100 hover:bg-purple-200 text-purple-800 font-bold py-2 px-4 rounded-md flex items-center justify-center">
                    <i class="fas fa-plus mr-2"></i> Añadir Emisor
                </button>
            </form>
            <!-- List -->
            <ul id="emitters-list" class="space-y-2 max-h-64 overflow-y-auto pr-2 text-gray-800">
                <!-- Emisores se renderizan aquí -->
            </ul>
        </div>
    </div>

    <!-- Recipients Modal -->
    <div id="recipients-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center no-print hidden z-50 p-4">
        <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-2xl text-gray-800">
            <div class="flex justify-between items-center mb-4 border-b pb-2">
                <h3 class="text-2xl font-bold text-purple-800">Gestionar Entes Receptores</h3>
                <button id="close-recipients-modal-btn" class="text-gray-400 hover:text-gray-600 text-2xl">&times;</button>
            </div>
            <!-- Form -->
            <form id="recipient-form" class="space-y-2 mb-4">
                <input type="hidden" id="recipient-edit-id">
                <input type="text" id="recipient-name-input" placeholder="Nombre del Ente" class="w-full p-2 border rounded-md text-gray-800" required>
                <input type="text" id="recipient-rif-input" placeholder="RIF (Ej: J-123...)" class="w-full p-2 border rounded-md text-gray-800">
                <input type="text" id="recipient-address-input" placeholder="Dirección" class="w-full p-2 border rounded-md text-gray-800">
                <input type="text" id="recipient-phone-input" placeholder="Teléfono" class="w-full p-2 border rounded-md text-gray-800">
                <button type="submit" id="recipient-submit-btn" class="w-full bg-purple-100 hover:bg-purple-200 text-purple-800 font-bold py-2 px-4 rounded-md flex items-center justify-center">
                    <i class="fas fa-plus mr-2"></i> Añadir Ente
                </button>
            </form>
            <!-- List -->
            <ul id="recipients-list" class="space-y-2 max-h-64 overflow-y-auto pr-2 text-gray-800">
                <!-- Receptores se renderizan aquí -->
            </ul>
        </div>
    </div>
    
    <!-- Workers Modal -->
    <!-- ***** CORRECCIÓN AQUÍ ***** -->
    <div id="workers-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center no-print hidden z-50 p-4">
        <!-- DIV CONTENEDOR DEL MODAL (AÑADIDO) -->
        <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-2xl text-gray-800">
            <!-- CAMBIO DE TEXTO: Gestionar Trabajadores -> Gestionar Pacientes -->
            <div class="flex justify-between items-center mb-4 border-b pb-2">
                <h3 class="text-2xl font-bold text-purple-800">Gestionar Pacientes</h3>
                <button id="close-workers-modal-btn" class="text-gray-400 hover:text-gray-600 text-2xl">&times;</button>
            </div>
            <!-- Form -->
            <form id="worker-form" class="space-y-2 mb-4">
                <input type="hidden" id="worker-edit-id">
                <input type="text" id="worker-name-input" placeholder="Nombre Apellido" class="w-full p-2 border rounded-md text-gray-800" required>
                <!-- CAMPO CI: Se aplica formato automático en JS -->
                <input type="text" id="worker-ci-input" placeholder="Ej: V-12345678" class="w-full p-2 border rounded-md text-gray-800" required>
                <input type="text" id="worker-familiar-input" placeholder="Paciente Familiar (Opcional)" class="w-full p-2 border rounded-md text-gray-800">
                <!-- CAMBIO DE TEXTO: Añadir Trabajador -> Añadir Paciente -->
                <button type="submit" id="worker-submit-btn" class="w-full bg-purple-100 hover:bg-purple-200 text-purple-800 font-bold py-2 px-4 rounded-md flex items-center justify-center">
                    <i class="fas fa-plus mr-2"></i> Añadir Paciente
                </button>
            </form>
            <!-- List -->
            <ul id="workers-list" class="space-y-2 max-h-64 overflow-y-auto pr-2 text-gray-800">
                <!-- Trabajadores se renderizan aquí -->
            </ul>
        </div> <!-- CIERRE DEL DIV CONTENEDOR (AÑADIDO) -->
    </div>
    <!-- ***** FIN DE LA CORRECCIÓN ***** -->

    <!-- Services Modal -->
    <div id="services-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center no-print hidden z-50 p-4">
        <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-2xl text-gray-800">
            <div class="flex justify-between items-center mb-4 border-b pb-2">
                <h3 class="text-2xl font-bold text-purple-800">Gestionar Catálogo de Servicios</h3>
                <button id="close-services-modal-btn" class="text-gray-400 hover:text-gray-600 text-2xl">&times;</button>
            </div>
            <!-- Form -->
            <!-- REESTRUCTURADO: Formulario de Servicios con Cantidad -->
            <form id="service-form" class="space-y-3 mb-4">
                 <input type="hidden" id="service-edit-id">
                <div>
                    <label for="service-desc-input" class="block text-sm font-medium text-gray-900 mb-1">Descripción del Servicio</label>
                    <input type="text" id="service-desc-input" placeholder="Descripción del servicio" class="w-full p-2 border rounded-md text-gray-800" required>
                </div>
                
                <div class="grid grid-cols-2 gap-3">
                    <div>
                         <label for="service-price-input" class="block text-sm font-medium text-gray-900 mb-1">Precio Total ($)</label>
                        <input type="number" id="service-price-input" placeholder="Ej: 60.00" step="0.01" class="w-full p-2 border rounded-md text-gray-800" required>
                    </div>
                     <div>
                         <label for="service-quantity-input" class="block text-sm font-medium text-gray-900 mb-1">Cantidad (para P/U)</label>
                        <input type="number" id="service-quantity-input" placeholder="Ej: 3" min="1" value="1" class="w-full p-2 border rounded-md text-gray-800" required>
                    </div>
                </div>

                <button type="submit" id="service-submit-btn" class="bg-purple-100 hover:bg-purple-200 text-purple-800 font-bold py-2 px-4 rounded-md flex items-center justify-center">
                    <i class="fas fa-plus mr-2"></i> Añadir
                </button>
            </form>
            <!-- List -->
            <ul id="services-list" class="space-y-2 max-h-64 overflow-y-auto pr-2 text-gray-800">
                <!-- Servicios se renderizan aquí -->
            </ul>
        </div>
    </div>

    <!-- ===== FIN DE MODALS ===== -->


    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- ESTADO Y DATOS ---
        let workers = JSON.parse(localStorage.getItem('workers')) || [];
        let services = JSON.parse(localStorage.getItem('services')) || [];
        let recipients = JSON.parse(localStorage.getItem('recipients')) || [
            { id: 1, name: 'El Tunal, C.A.', rif: 'J-30024477-6', address: 'Final Av. El Cementerio, Via Caserio Morón. Quibor Edo Lara', phone: '0253-4911001' }
        ];
        let emitters = JSON.parse(localStorage.getItem('emitters')) || [
            { id: 1, name: 'Dra. Isabel Cristina Vargas Silva', description: 'Ginecólogo y Obstetra', useCorrelative: false }
        ];
        // REFACTOR: receiptItems ahora es un array plano de objetos de servicio
        let receiptItems = [];
        let bcvRate = 0;
        // Correlativo de recibo (cargado desde localStorage)
        let nextReceiptNumber = JSON.parse(localStorage.getItem('receiptCorrelative')) || 1;


        // --- SELECTORES DEL DOM ---
        const bcvRateInput = document.getElementById('bcv-rate');
        const receiptDateInput = document.getElementById('receipt-date');
        const receiptNumberInput = document.getElementById('receipt-number-input');
        const previewDate = document.getElementById('preview-date');
        const previewReceiptNumber = document.getElementById('preview-receipt-number');
        // Wrapper para N° Recibo condicional
        const previewReceiptNumberWrapper = document.getElementById('preview-receipt-number-wrapper');

        
        // Forms
        const addItemForm = document.getElementById('add-item-form');
        const workerForm = document.getElementById('worker-form');
        const serviceForm = document.getElementById('service-form');
        const emitterForm = document.getElementById('emitter-form');
        const recipientForm = document.getElementById('recipient-form');

        // Inputs Emisor
        const emitterNameInput = document.getElementById('emitter-name-input');
        const emitterDescInput = document.getElementById('emitter-desc-input');
        const emitterEditId = document.getElementById('emitter-edit-id');
        const emitterSubmitBtn = document.getElementById('emitter-submit-btn');
        // Checkbox Correlativo
        const emitterCorrelativeInput = document.getElementById('emitter-correlative-input');


        // Inputs Receptor
        const recipientNameInput = document.getElementById('recipient-name-input');
        const recipientRifInput = document.getElementById('recipient-rif-input');
        const recipientAddressInput = document.getElementById('recipient-address-input');
        const recipientPhoneInput = document.getElementById('recipient-phone-input');
        const recipientEditId = document.getElementById('recipient-edit-id');
        const recipientSubmitBtn = document.getElementById('recipient-submit-btn');
        
        // Inputs Trabajador
        const workerNameInput = document.getElementById('worker-name-input');
        const workerCiInput = document.getElementById('worker-ci-input');
        const workerFamiliarInput = document.getElementById('worker-familiar-input');
        const workerEditId = document.getElementById('worker-edit-id');
        const workerSubmitBtn = document.getElementById('worker-submit-btn');
        
        // Inputs Servicio
        const serviceDescInput = document.getElementById('service-desc-input');
        const servicePriceInput = document.getElementById('service-price-input');
        // AÑADIDO: Selector para cantidad en modal
        const serviceQuantityModalInput = document.getElementById('service-quantity-input');
        const serviceEditId = document.getElementById('service-edit-id');
        const serviceSubmitBtn = document.getElementById('service-submit-btn');


        // Selects & Inputs (Main Form - AHORA DATALISTS)
        const emitterInput = document.getElementById('emitter-input');
        const emitterSelectId = document.getElementById('emitter-select-id'); // Hidden ID
        const recipientInput = document.getElementById('recipient-input');
        const recipientSelectId = document.getElementById('recipient-select-id'); // Hidden ID
        const workerInput = document.getElementById('worker-input');
        const workerSelectId = document.getElementById('worker-select-id'); // Hidden ID
        const serviceInput = document.getElementById('service-input');
        const serviceSelectId = document.getElementById('service-select-id'); // Hidden ID
        
        const workerDatalist = document.getElementById('worker-options');
        const emitterDatalist = document.getElementById('emitter-options');
        const recipientDatalist = document.getElementById('recipient-options');
        const serviceDatalist = document.getElementById('service-options');
        
        const patientNameInput = document.getElementById('patient-name');
        // NUEVO SELECTOR: Fecha del Servicio
        const serviceDateInput = document.getElementById('service-date');
        const serviceQuantityInput = document.getElementById('service-quantity');
        const servicePriceDisplay = document.getElementById('service-price-display');

        // Listas de gestión (dentro de modals)
        const workersList = document.getElementById('workers-list');
        const servicesList = document.getElementById('services-list');
        const recipientsList = document.getElementById('recipients-list');
        const emittersList = document.getElementById('emitters-list');
        
        // Vista Previa
        const receiptItemsContainer = document.getElementById('receipt-items-container');
        const subtotalUsd = document.getElementById('subtotal-usd');
        const previewBcvRate = document.getElementById('preview-bcv-rate');
        const totalBs = document.getElementById('total-bs');
        
        // Preview Emitter/Recipient
        const previewEmitterName = document.getElementById('preview-emitter-name');
        const previewEmitterDesc = document.getElementById('preview-emitter-desc');
        const previewRecipientInfo = document.getElementById('preview-recipient-info');
        const previewRecipientName = document.getElementById('preview-recipient-name');
        const previewRecipientRif = document.getElementById('preview-recipient-rif');
        const previewRecipientAddress = document.getElementById('preview-recipient-address');
        const previewRecipientPhone = document.getElementById('preview-recipient-phone');


        // Botones
        const downloadPdfButton = document.getElementById('download-pdf-button');
        const resetButton = document.getElementById('reset-button');
        
        // Modal Reseteo
        const resetModal = document.getElementById('reset-modal');
        const cancelResetBtn = document.getElementById('cancel-reset-btn');
        const confirmResetBtn = document.getElementById('confirm-reset-btn');
        
        // Modals Gestión y Botones
        const emittersModal = document.getElementById('emitters-modal');
        const recipientsModal = document.getElementById('recipients-modal');
        const workersModal = document.getElementById('workers-modal');
        const servicesModal = document.getElementById('services-modal');
        
        const manageEmittersBtn = document.getElementById('manage-emitters-btn');
        const manageRecipientsBtn = document.getElementById('manage-recipients-btn');
        const manageWorkersBtn = document.getElementById('manage-workers-btn');
        const manageServicesBtn = document.getElementById('manage-services-btn');

        const closeEmittersModalBtn = document.getElementById('close-emitters-modal-btn');
        const closeRecipientsModalBtn = document.getElementById('close-recipients-modal-btn');
        const closeWorkersModalBtn = document.getElementById('close-workers-modal-btn');
        const closeServicesModalBtn = document.getElementById('close-services-modal-btn');

        // --- FUNCIONES DE UTILIDAD ---
        
        const toTitleCase = (str) => {
            if (!str) return '';
            return str.toLowerCase().split(' ').map(word => {
                return word.charAt(0).toUpperCase() + word.slice(1);
            }).join(' ');
        };

        const formatCi = (ci) => {
            if (!ci) return '';
            
            let formattedCi = ci.toUpperCase().trim();
            let prefixMatch = formattedCi.match(/^([VEPJG\s-]*?)?(\d+)/);
            let numberPart = '';
            let prefix = '';

            if (prefixMatch) {
                numberPart = prefixMatch[2].replace(/[.\-]/g, '');
                let tempPrefix = (prefixMatch[1] || '').replace(/[\s-]/g, '');

                if (tempPrefix && 'VEPJG'.includes(tempPrefix.charAt(0))) {
                    prefix = tempPrefix.charAt(0);
                } else if (ci.toLowerCase().includes('j')) {
                    prefix = 'J';
                } else {
                    prefix = 'V'; // Default a 'V'
                }
            } else {
                 return formattedCi.replace(/[.\-]/g, '');
            }

            let numberFormatted = numberPart.replace(/\B(?=(\d{3})+(?!\d))/g, ".");
            let result = `${prefix}-${numberFormatted}`;
            
            let lastDigitMatch = ci.match(/(\d)$/);
            if(lastDigitMatch) {
                const originalNumberPart = ci.replace(/[^\d]/g, '');
                const lastDigit = originalNumberPart.slice(-1);

                if(!numberFormatted.endsWith(lastDigit) && numberPart.length > 7) { 
                    const dashMatch = formattedCi.match(/(\d)-(\d)$/);
                    if (dashMatch) {
                        result += `-${dashMatch[2]}`;
                    }
                }
            }
            
            return result;
        };


        const formatCurrency = (amount, currency = 'USD') => {
            if (currency === 'VES') {
                // CORRECCIÓN: Añadido maximumFractionDigits para forzar 2 decimales
                return new Intl.NumberFormat('es-VE', { style: 'decimal', minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(amount);
            }
            return new Intl.NumberFormat('en-US', { style: 'currency', currency, minimumFractionDigits: 2 }).format(amount);
        };

        // NUEVA FUNCIÓN DE UTILIDAD PARA FORMATO DE FECHA
        const formatDateDDMMYY = (isoDate) => {
            if (!isoDate) return '--/--/--';
            try {
                // Se añade T00:00:00 para asegurar que se parsee como fecha local y no UTC
                const date = new Date(isoDate + 'T00:00:00'); 
                const day = String(date.getDate()).padStart(2, '0');
                const month = String(date.getMonth() + 1).padStart(2, '0'); // Meses son 0-indexados
                const year = String(date.getFullYear()).slice(-2);
                return `${day}-${month}-${year}`;
            } catch (e) {
                console.error("Error formatting date: ", isoDate, e);
                return '--/--/--';
            }
        };

        const saveToLocalStorage = () => {
            localStorage.setItem('workers', JSON.stringify(workers));
            localStorage.setItem('services', JSON.stringify(services));
            localStorage.setItem('recipients', JSON.stringify(recipients));
            localStorage.setItem('emitters', JSON.stringify(emitters));
            // Guardar el correlativo también (aunque se guarda al descargar)
            localStorage.setItem('receiptCorrelative', JSON.stringify(nextReceiptNumber));
        };

        const findIdFromDatalistInput = (inputElement, datalistElement) => {
            const selectedOption = Array.from(datalistElement.options)
                .find(option => option.value === inputElement.value);
            return selectedOption ? parseInt(selectedOption.dataset.id) : null;
        }

        // --- FUNCIONES DE RENDERIZADO Y POBLADO ---

        // Emisores
        const renderEmittersList = () => {
            emittersList.innerHTML = emitters.map(e => `
                <li class="flex justify-between items-center p-2 bg-purple-50 rounded-md text-sm">
                    <div>
                        <span class="font-semibold">${e.name}</span>
                        <span class="block text-xs text-purple-700">${e.description} ${e.useCorrelative ? '(Correl.)' : ''}</span>
                    </div>
                    <div>
                        <button data-id="${e.id}" class="edit-emitter-btn list-btn edit-btn-list"><i class="fas fa-pencil-alt"></i></button>
                        <button data-id="${e.id}" class="delete-emitter-btn list-btn delete-btn-list"><i class="fas fa-trash-alt"></i></button>
                    </div>
                </li>`).join('');
            populateEmitterDropdown();
        };
        const populateEmitterDropdown = () => {
            emitterDatalist.innerHTML = emitters.map(e => 
                `<option data-id="${e.id}" value="${e.name} (${e.description})"></option>`
            ).join('');
            renderEmitterPreview();
        };
        const renderEmitterPreview = (selectedId) => {
            const idToUse = selectedId || emitterSelectId.value;
            const emitter = emitters.find(e => e.id == idToUse);
            if (emitter) {
                previewEmitterName.textContent = emitter.name;
                previewEmitterDesc.textContent = emitter.description;
            } else {
                previewEmitterName.textContent = 'Seleccione un emisor';
                previewEmitterDesc.textContent = '...';
            }
        };
        const resetEmitterForm = () => {
            emitterForm.reset();
            emitterEditId.value = '';
            emitterCorrelativeInput.checked = false; // Reset checkbox
            emitterSubmitBtn.innerHTML = '<i class="fas fa-plus mr-2"></i> Añadir Emisor';
        };

        // Receptores
        const renderRecipientsList = () => {
            recipientsList.innerHTML = recipients.map(r => `
                <li class="flex justify-between items-center p-2 bg-purple-50 rounded-md text-sm">
                    <div>
                        <span class="font-semibold">${r.name}</span>
                        <span class="block text-xs text-purple-700">${r.rif || ''}</span>
                    </div>
                    <div>
                        <button data-id="${r.id}" class="edit-recipient-btn list-btn edit-btn-list"><i class="fas fa-pencil-alt"></i></button>
                        <button data-id="${r.id}" class="delete-recipient-btn list-btn delete-btn-list"><i class="fas fa-trash-alt"></i></button>
                    </div>
                </li>`).join('');
            populateRecipientDropdown();
        };
        const populateRecipientDropdown = () => {
             recipientDatalist.innerHTML = recipients.map(r => 
                `<option data-id="${r.id}" value="${r.name} (${r.rif || 'Sin RIF'})"></option>`
            ).join('');
            renderRecipientPreview();
        };
        const renderRecipientPreview = (selectedId) => {
            const idToUse = selectedId || recipientSelectId.value;
            const recipient = recipients.find(r => r.id == idToUse);
            if (recipient) {
                previewRecipientName.textContent = recipient.name;
                previewRecipientRif.textContent = recipient.rif ? `RIF: ${recipient.rif}` : '';
                previewRecipientAddress.textContent = recipient.address;
                previewRecipientPhone.textContent = recipient.phone ? `Telf: ${recipient.phone}` : '';
            } else {
                previewRecipientName.textContent = 'Seleccione un ente receptor';
                previewRecipientRif.textContent = '';
                previewRecipientAddress.textContent = '';
                previewRecipientPhone.textContent = '';
            }
        };
        const resetRecipientForm = () => {
            recipientForm.reset();
            recipientEditId.value = '';
            recipientSubmitBtn.innerHTML = '<i class="fas fa-plus mr-2"></i> Añadir Ente';
        };

        // Trabajadores
        const renderWorkersList = () => {
            workersList.innerHTML = workers.map(w => `
                <li class="flex justify-between items-center p-2 bg-purple-50 rounded-md text-sm">
                    <div>
                        <span class="font-semibold">${w.name} - ${w.ci}</span>
                        ${w.familiar ? `<span class="block text-xs text-purple-700">Familiar: ${w.familiar}</span>` : ''}
                    </div>
                    <div>
                        <button data-id="${w.id}" class="edit-worker-btn list-btn edit-btn-list"><i class="fas fa-pencil-alt"></i></button>
                        <button data-id="${w.id}" class="delete-worker-btn list-btn delete-btn-list"><i class="fas fa-trash-alt"></i></button>
                    </div>
                </li>`).join('');
            populateWorkerDropdown();
        };
        const populateWorkerDropdown = () => {
            workerDatalist.innerHTML = workers.map(w => 
                `<option data-id="${w.id}" value="${w.name} - ${w.ci}"></option>`
            ).join('');
        };
        const resetWorkerForm = () => {
            workerForm.reset();
            workerEditId.value = '';
            // CAMBIO DE TEXTO: Añadir Trabajador -> Añadir Paciente
            workerSubmitBtn.innerHTML = '<i class="fas fa-plus mr-2"></i> Añadir Paciente';
        };

        // Servicios
        const renderServicesList = () => {
            // ACTUALIZADO: Mostrar Cant, P/U y Total
            servicesList.innerHTML = services.map(s => {
                const quantity = s.quantity || 1;
                const unitPrice = s.price / quantity;
                return `
                <li class="flex justify-between items-center p-2 bg-purple-50 rounded-md text-sm">
                    <div>
                        <span class="font-semibold">${s.description}</span>
                        <span class="block text-xs text-purple-700">Cant: ${quantity} | P/U: ${formatCurrency(unitPrice)}</span>
                    </div>
                    <div class="flex items-center">
                        <span class="font-semibold text-sm mr-4">Total: ${formatCurrency(s.price)}</span>
                        <button data-id="${s.id}" class="edit-service-btn list-btn edit-btn-list"><i class="fas fa-pencil-alt"></i></button>
                        <button data-id="${s.id}" class="delete-service-btn list-btn delete-btn-list"><i class="fas fa-trash-alt"></i></button>
                    </div>
                </li>
                `}).join('');
            populateServiceDropdown();
        };
        const populateServiceDropdown = () => {
            // ACTUALIZADO: Mostrar P/U en dropdown
            serviceDatalist.innerHTML = services.map(s => {
                const unitPrice = s.price / (s.quantity || 1);
                // CORRECCIÓN: Se elimina el precio del 'value' del datalist
                return `<option data-id="${s.id}" value="${s.description}"></option>`
            }).join('');
            updatePriceDisplay();
        };
        const updatePriceDisplay = () => {
            // ACTUALIZADO: Mostrar P/U en P/U Display
            const selectedServiceId = serviceSelectId.value;
            const service = services.find(s => s.id == selectedServiceId);
            const unitPrice = service ? service.price / (service.quantity || 1) : 0;
            servicePriceDisplay.textContent = service ? formatCurrency(unitPrice) : '$0.00';
        };
        const resetServiceForm = () => {
            serviceForm.reset();
            serviceEditId.value = '';
            serviceQuantityModalInput.value = 1; // Resetear cantidad
            serviceSubmitBtn.innerHTML = '<i class="fas fa-plus mr-2"></i> Añadir';
        };
        
        // Recibo (Vista Previa)
        // REFACTOR: renderReceiptPreview ahora crea una sola tabla plana
        const renderReceiptPreview = () => {
            // Se quitan las clases de tamaño de fuente de Tailwind, se controlan por CSS <style>
            const tableHeader = `
                <table class="w-full">
                    <thead class="bg-purple-50">
                        <tr>
                            <!-- CORRECCIÓN: Se añadieron anchos (width) con style para mejor control -->
                            <th class="px-2 py-2 text-left font-medium text-purple-700" style="width: 3%;">N°</th>
                            <th class="px-2 py-2 text-left font-medium text-purple-700" style="width: 8%;">Fecha</th>
                            <!-- CAMBIO DE TEXTO: Se fusionó Nombres/C.I y Paciente -->
                            <th class="px-2 py-2 text-left font-medium text-purple-700" style="width: 40%;">Nombres/C.I/Paciente</th> <!-- 35% -> 40% -->
                            <th class="px-2 py-2 text-left font-medium text-purple-700" style="width: 12%;">Servicio</th> <!-- 17% -> 12% -->
                            <th class="px-2 py-2 text-center font-medium text-purple-700" style="width: 5%;">Cant.</th>
                            <th class="px-2 py-2 text-right font-medium text-purple-700" style="width: 8%;">P/U ($)</th>
                            <th class="px-2 py-2 text-right font-medium text-purple-700" style="width: 8%;">Total ($)</th>
                            <!-- NUEVA COLUMNA: Total (Bs.) -->
                            <th class="px-2 py-2 text-right font-medium text-purple-700" style="width: 11%;">Total (Bs.)</th>
                            <th class="no-print" style="width: 5%;"></th>
                        </tr>
                    </thead>
            `;

            if (receiptItems.length === 0) {
                receiptItemsContainer.innerHTML = tableHeader + `
                        <tbody>
                            <tr>
                                <td colspan="9" class="text-center text-gray-500 py-10">
                                    Aún no se han agregado items al recibo.
                                </td>
                            </tr>
                        </tbody>
                    </table>`;
                renderTotals();
                return;
            }
            
            // --- INICIO DE CORRECCIÓN: Ordenar por fecha de servicio ---
            receiptItems.sort((a, b) => {
                // Se crean fechas para asegurar una comparación correcta
                const dateA = new Date(a.serviceDate + 'T00:00:00');
                const dateB = new Date(b.serviceDate + 'T00:00:00');
                return dateA - dateB;
            });
            // --- FIN DE CORRECCIÓN ---

            const itemsHtml = receiptItems.map((item, index) => {
                const total = item.quantity * item.price;
                // --- INICIO DE CORRECCIÓN: Usar nuevo formato de fecha dd-mm-yy ---
                const formattedDate = formatDateDDMMYY(item.serviceDate);
                // --- FIN DE CORRECCIÓN ---
                
                // --- INICIO DE CORRECCIÓN: Calcular Total (Bs.) por item ---
                const totalBsItem = total * bcvRate;
                // --- FIN DE CORRECCIÓN ---

                return `
                    <tr class="hover:bg-purple-50 border-b border-gray-100">
                        <td class="px-2 py-2 font-medium text-gray-500">${index + 1}</td>
                        <td class="px-2 py-2">${formattedDate}</td>
                        <!-- CORRECCIÓN: Se fusionó Nombres/C.I y Paciente -->
                        <td class="px-2 py-2">
                            <span class="font-semibold block">${item.workerName}</span>
                            <span class="text-gray-600 block">${item.workerCi}</span>
                            ${item.patientName ? `<span class="text-purple-700" style="font-size: 7pt;">Paciente: ${item.patientName}</span>` : ''}
                        </td>
                        <td class="px-2 py-2">${item.description}</td>
                        <td class="px-2 py-2 text-center">${item.quantity}</td>
                        <td class="px-2 py-2 text-right">${formatCurrency(item.price)}</td>
                        <td class="px-2 py-2 text-right font-medium">${formatCurrency(total)}</td>
                        <!-- NUEVA CELDA: Total (Bs.) por item -->
                        <td class="px-2 py-2 text-right">${formatCurrency(totalBsItem, 'VES')}</td>
                        <td class="px-1 py-2 text-center no-print">
                            <button data-item-instance="${item.instanceId}" class="delete-receipt-item-btn text-red-500 hover:text-red-700 font-bold text-lg">&times;</button>
                        </td>
                    </tr>
                `;
            }).join('');

            // Build the full table structure
            receiptItemsContainer.innerHTML = tableHeader + `
                    <tbody>
                        ${itemsHtml}
                    </tbody>
                </table>
            `;
            
            renderTotals();
        };

        // REFACTOR: renderTotals ahora es más simple
        const renderTotals = () => {
            const subtotal = receiptItems.reduce((total, item) => {
                return total + (item.quantity * item.price);
            }, 0);

            const totalInBs = subtotal * bcvRate;

            subtotalUsd.textContent = formatCurrency(subtotal);
            previewBcvRate.textContent = bcvRate.toFixed(2);
            totalBs.textContent = `Bs. ${formatCurrency(totalInBs, 'VES')}`;
        };
        

        // --- MANEJADORES de EVENTOS ---
        
        // --- Eventos de Modals (Se mantienen iguales) ---
        manageEmittersBtn.addEventListener('click', () => emittersModal.classList.remove('hidden'));
        closeEmittersModalBtn.addEventListener('click', () => { emittersModal.classList.add('hidden'); resetEmitterForm(); });
        
        manageRecipientsBtn.addEventListener('click', () => recipientsModal.classList.remove('hidden'));
        closeRecipientsModalBtn.addEventListener('click', () => { recipientsModal.classList.add('hidden'); resetRecipientForm(); });

        manageWorkersBtn.addEventListener('click', () => workersModal.classList.remove('hidden'));
        closeWorkersModalBtn.addEventListener('click', () => { workersModal.classList.add('hidden'); resetWorkerForm(); });

        manageServicesBtn.addEventListener('click', () => servicesModal.classList.remove('hidden'));
        closeServicesModalBtn.addEventListener('click', () => { servicesModal.classList.add('hidden'); resetServiceForm(); });

        // --- Eventos de Forms de Gestión ---

        // Emisor Form (ACTUALIZADO con correlativo)
        emitterForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const name = toTitleCase(emitterNameInput.value);
            const description = toTitleCase(emitterDescInput.value);
            const useCorrelative = emitterCorrelativeInput.checked; // Get checkbox value
            const editId = emitterEditId.value;

            if (editId) {
                const emitter = emitters.find(e => e.id == editId);
                if (emitter) {
                    emitter.name = name;
                    emitter.description = description;
                    emitter.useCorrelative = useCorrelative; // Save checkbox value
                }
            } else {
                emitters.push({ id: Date.now(), name, description, useCorrelative }); // Save checkbox value
            }
            saveToLocalStorage();
            renderEmittersList(); 
            resetEmitterForm();
            if(emitterSelectId.value == editId) renderEmitterPreview(editId);
        });

        // Receptor Form
        recipientForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const editId = recipientEditId.value;
            const data = {
                name: toTitleCase(recipientNameInput.value),
                rif: formatCi(recipientRifInput.value),
                address: recipientAddressInput.value,
                phone: recipientPhoneInput.value,
            };

            if (editId) {
                const recipient = recipients.find(r => r.id == editId);
                if (recipient) {
                    Object.assign(recipient, data);
                }
            } else {
                recipients.push({ id: Date.now(), ...data });
            }
            saveToLocalStorage();
            renderRecipientsList();
            resetRecipientForm();
            if(recipientSelectId.value == editId) renderRecipientPreview(editId);
        });

        // Trabajador Form
        workerForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const name = toTitleCase(workerNameInput.value);
            const ci = formatCi(workerCiInput.value);
            const familiar = toTitleCase(workerFamiliarInput.value.trim());
            const editId = workerEditId.value;

            if (editId) {
                const worker = workers.find(w => w.id == editId);
                if (worker) {
                    worker.name = name;
                    worker.ci = ci;
                    worker.familiar = familiar;
                }
            } else {
                if (name && ci) {
                    workers.push({ id: Date.now(), name, ci, familiar });
                }
            }
            saveToLocalStorage();
            renderWorkersList();
            resetWorkerForm();
        });

        // Servicio Form
        serviceForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const description = serviceDescInput.value;
            const price = parseFloat(servicePriceInput.value);
            const quantity = parseInt(serviceQuantityModalInput.value) || 1; // OBTENER CANTIDAD
            const editId = serviceEditId.value;

            if (description && price >= 0) {
                 if (editId) {
                    const service = services.find(s => s.id == editId);
                    if (service) {
                        service.description = description;
                        service.price = price;
                        service.quantity = quantity; // GUARDAR CANTIDAD
                    }
                } else {
                    services.push({ id: Date.now(), description, price, quantity }); // GUARDAR CANTIDAD
                }
                saveToLocalStorage();
                renderServicesList();
                resetServiceForm();
            }
        });

        // --- Eventos de Listas (Edit/Delete) ---
        
        // Lista Emisores (ACTUALIZADO con correlativo)
        emittersList.addEventListener('click', e => {
            const btn = e.target.closest('button');
            if (!btn) return;
            const id = parseInt(btn.dataset.id);
            
            if (btn.classList.contains('delete-emitter-btn')) {
                emitters = emitters.filter(e => e.id !== id);
                saveToLocalStorage();
                renderEmittersList();
                if (emitterEditId.value == id) resetEmitterForm();
                if(emitterSelectId.value == id) { emitterInput.value = ''; emitterSelectId.value = ''; renderEmitterPreview(); }
            }
            if (btn.classList.contains('edit-emitter-btn')) {
                const emitter = emitters.find(e => e.id === id);
                if (emitter) {
                    emitterNameInput.value = emitter.name; 
                    emitterDescInput.value = emitter.description;
                    emitterCorrelativeInput.checked = emitter.useCorrelative || false; // Set checkbox
                    emitterEditId.value = id;
                    emitterSubmitBtn.innerHTML = '<i class="fas fa-save mr-2"></i> Guardar Cambios';
                    emitterNameInput.focus();
                }
            }
        });
        
        // Lista Receptores
        recipientsList.addEventListener('click', e => {
            const btn = e.target.closest('button');
            if (!btn) return;
            const id = parseInt(btn.dataset.id);

            if (btn.classList.contains('delete-recipient-btn')) {
                recipients = recipients.filter(r => r.id !== id);
                saveToLocalStorage();
                renderRecipientsList();
                if (recipientEditId.value == id) resetRecipientForm();
                if(recipientSelectId.value == id) { recipientInput.value = ''; recipientSelectId.value = ''; renderRecipientPreview(); }
            }
            if (btn.classList.contains('edit-recipient-btn')) {
                const recipient = recipients.find(r => r.id === id);
                if (recipient) {
                    recipientNameInput.value = recipient.name;
                    recipientRifInput.value = recipient.rif;
                    recipientAddressInput.value = recipient.address;
                    recipientPhoneInput.value = recipient.phone;
                    recipientEditId.value = id;
                    recipientSubmitBtn.innerHTML = '<i class="fas fa-save mr-2"></i> Guardar Cambios';
                    recipientNameInput.focus();
                }
            }
        });
        
        // Lista Trabajadores
        workersList.addEventListener('click', e => {
            const btn = e.target.closest('button');
            if (!btn) return;
            const id = parseInt(btn.dataset.id);

            if (btn.classList.contains('delete-worker-btn')) {
                workers = workers.filter(w => w.id !== id);
                saveToLocalStorage();
                renderWorkersList();
                if (workerEditId.value == id) resetWorkerForm();
                if(workerSelectId.value == id) { workerInput.value = ''; workerSelectId.value = ''; }
            }
            if (btn.classList.contains('edit-worker-btn')) {
                const worker = workers.find(w => w.id === id);
                if (worker) {
                    workerNameInput.value = worker.name;
                    workerCiInput.value = worker.ci;
                    workerFamiliarInput.value = worker.familiar || '';
                    workerEditId.value = id;
                    workerSubmitBtn.innerHTML = '<i class="fas fa-save mr-2"></i> Guardar Cambios';
                    workerNameInput.focus();
                }
            }
        });

        // Lista Servicios
        servicesList.addEventListener('click', e => {
            const btn = e.target.closest('button');
            if (!btn) return;
            const id = parseInt(btn.dataset.id);

            if (btn.classList.contains('delete-service-btn')) {
                services = services.filter(s => s.id !== id);
                saveToLocalStorage();
                renderServicesList();
                 if (serviceEditId.value == id) resetServiceForm();
                 if(serviceSelectId.value == id) { serviceInput.value = ''; serviceSelectId.value = ''; updatePriceDisplay(); }
            }
            if (btn.classList.contains('edit-service-btn')) {
                const service = services.find(s => s.id === id);
                if (service) {
                    serviceDescInput.value = service.description;
                    servicePriceInput.value = service.price;
                    serviceQuantityModalInput.value = service.quantity || 1; // LLENAR CANTIDAD
                    serviceEditId.value = id;
                    serviceSubmitBtn.innerHTML = '<i class="fas fa-save mr-2"></i> Guardar';
                    serviceDescInput.focus();
                }
            }
        });

        // --- Eventos del Form Principal (Añadir a Recibo) ---

        // REFACTOR: El submit ahora crea un item plano
        addItemForm.addEventListener('submit', (e) => {
            e.preventDefault();
            
            const selectedWorkerId = parseInt(workerSelectId.value);
            const selectedServiceId = parseInt(serviceSelectId.value);
            const quantity = parseInt(serviceQuantityInput.value);
            const serviceDate = serviceDateInput.value;
            
            let patientName = toTitleCase(patientNameInput.value.trim());

            if (!selectedWorkerId || !selectedServiceId || quantity < 1 || !serviceDate) {
                if (!selectedWorkerId) workerInput.style.border = '1px solid red'; else workerInput.style.border = '1px solid #ccc';
                if (!selectedServiceId) serviceInput.style.border = '1px solid red'; else serviceInput.style.border = '1px solid #ccc';
                if (!serviceDate) serviceDateInput.style.border = '1px solid red'; else serviceDateInput.style.border = '1px solid #ccc';
                return;
            } else {
                 workerInput.style.border = '1px solid #ccc';
                 serviceInput.style.border = '1px solid #ccc';
                 serviceDateInput.style.border = '1px solid #ccc';
            }
            
            const worker = workers.find(w => w.id === selectedWorkerId);
            const service = services.find(s => s.id === selectedServiceId);
            
            // OBTENER PRECIO UNITARIO
            const unitPrice = service.price / (service.quantity || 1);
            
            if (!patientName && worker.familiar) {
                patientName = worker.familiar;
            }

            const newItem = {
                instanceId: Date.now(),
                workerId: worker.id,
                workerName: worker.name,
                workerCi: worker.ci,
                patientName: patientName,
                serviceId: service.id,
                description: service.description,
                price: unitPrice, // GUARDAR PRECIO UNITARIO
                quantity: quantity,
                serviceDate: serviceDate
            };
            
            receiptItems.push(newItem);
            renderReceiptPreview();
            
            const today = new Date().toISOString().split('T')[0];
            addItemForm.reset();
            serviceQuantityInput.value = "1";
            serviceInput.value = ''; 
            workerInput.value = ''; 
            serviceSelectId.value = ''; 
            workerSelectId.value = ''; 
            patientNameInput.value = ''; 
            serviceDateInput.value = today;
            updatePriceDisplay();
        });
        
        // REFACTOR: Borrar item del recibo ahora usa el array plano
        receiptItemsContainer.addEventListener('click', e => {
            const btn = e.target.closest('button');
            if (btn && btn.classList.contains('delete-receipt-item-btn')) {
                const instanceId = parseInt(btn.dataset.itemInstance); 
                receiptItems = receiptItems.filter(item => item.instanceId !== instanceId);
                renderReceiptPreview();
            }
        });

        // --- Eventos Generales ---
        bcvRateInput.addEventListener('input', e => {
            bcvRate = parseFloat(e.target.value) || 0;
            // CORRECCIÓN: Llamar a renderReceiptPreview para que recalcule
            // la tabla completa, no solo los totales.
            // renderTotals(); <-- Esta era la línea incorrecta
            renderReceiptPreview(); // <-- Esta es la línea correcta
        });
        
        receiptDateInput.addEventListener('input', (e) => {
            previewDate.textContent = e.target.value ? new Date(e.target.value + 'T00:00:00').toLocaleDateString('es-VE') : '--/--/----';
        });
        
        // N° Recibo (ACTUALIZADO para condicional)
        receiptNumberInput.addEventListener('input', (e) => {
            const number = e.target.value;
            if (number) {
                previewReceiptNumber.textContent = number;
                previewReceiptNumberWrapper.style.display = 'block';
            } else {
                previewReceiptNumber.textContent = 'N/A';
                previewReceiptNumberWrapper.style.display = 'none';
            }
        });
        
        // Listeners para Datalists (Actualizar Hidden ID y Preview)
        // ACTUALIZADO con lógica de correlativo
        emitterInput.addEventListener('input', () => {
            const id = findIdFromDatalistInput(emitterInput, emitterDatalist);
            emitterSelectId.value = id || '';
            renderEmitterPreview(id);
            
            // Lógica de Correlativo
            const selectedEmitter = emitters.find(e => e.id === id);
            if (selectedEmitter && selectedEmitter.useCorrelative) {
                // Cargar el *próximo* número guardado
                nextReceiptNumber = JSON.parse(localStorage.getItem('receiptCorrelative')) || 1;
                receiptNumberInput.value = String(nextReceiptNumber).padStart(3, '0');
                receiptNumberInput.disabled = true;
            } else {
                receiptNumberInput.disabled = false;
                // No limpiamos el valor, para que el opcional manual persista
                // receiptNumberInput.value = ''; 
            }
            // Disparar el evento de input manually para actualizar la vista previa
            receiptNumberInput.dispatchEvent(new Event('input'));
        });

        recipientInput.addEventListener('input', () => {
            const id = findIdFromDatalistInput(recipientInput, recipientDatalist);
            recipientSelectId.value = id || '';
            renderRecipientPreview(id);
        });

        workerInput.addEventListener('input', () => {
            const id = findIdFromDatalistInput(workerInput, workerDatalist);
            workerSelectId.value = id || '';
            
            const selectedWorker = workers.find(w => w.id === id);
            patientNameInput.value = selectedWorker && selectedWorker.familiar ? selectedWorker.familiar : '';
        });

        serviceInput.addEventListener('input', () => {
            const id = findIdFromDatalistInput(serviceInput, serviceDatalist);
            serviceSelectId.value = id || '';
            
            // --- INICIO DE CORRECCIÓN: Tomar cantidad por defecto del servicio ---
            const service = services.find(s => s.id == id);
            if (service) {
                serviceQuantityInput.value = service.quantity || 1;
            }
            // --- FIN DE CORRECCIÓN ---

            updatePriceDisplay();
        });
        
        // Evento del botón de Descargar PDF (ACTUALIZADO con correlativo)
        downloadPdfButton.addEventListener('click', () => {
            const originalButtonHtml = downloadPdfButton.innerHTML;
            
            downloadPdfButton.disabled = true;
            downloadPdfButton.innerHTML = `
                <i class="fas fa-spinner fa-spin mr-2"></i> Generando PDF...
            `;
            
            try {
                const { jsPDF } = window.jspdf;
                const receiptElement = document.getElementById('receipt-preview');

                const deleteButtons = receiptElement.querySelectorAll('.delete-receipt-item-btn');
                deleteButtons.forEach(btn => btn.style.visibility = 'hidden');

                html2canvas(receiptElement, {
                    scale: 2, // Mejor calidad
                    useCORS: true,
                    windowWidth: receiptElement.scrollWidth,
                    windowHeight: receiptElement.scrollHeight
                }).then(canvas => {
                    const imgData = canvas.toDataURL('image/png');
                    
                    // --- INICIO DE LA CORRECCIÓN: Añadir Márgenes ---
                    const margin = 10; // 10mm de margen
                    const pdfWidth = 210 - (margin * 2); // Ancho A4 (210mm) - márgenes
                    const usablePageHeight = 297 - (margin * 2); // Alto A4 (297mm) - márgenes
                    // --- FIN DE LA CORRECCIÓN ---
                    
                    const imgHeight = (canvas.height * pdfWidth) / canvas.width;
                    let heightLeft = imgHeight;
                    
                    const doc = new jsPDF('p', 'mm', 'a4'); // 'p' = portrait (vertical)
                    
                    let position = margin; // Posición Y inicial con margen superior

                    // Añadir imagen con márgenes
                    doc.addImage(imgData, 'PNG', margin, position, pdfWidth, imgHeight);
                    heightLeft -= usablePageHeight; // Reducir la altura usable de la página

                    while (heightLeft >= 0) {
                        position = heightLeft - imgHeight + margin; // Calcular nueva posición Y con margen
                        doc.addPage();
                        doc.addImage(imgData, 'PNG', margin, position, pdfWidth, imgHeight); // Añadir imagen con márgenes
                        heightLeft -= usablePageHeight; // Reducir la altura usable
                    }
                    
                    const receiptNumber = document.getElementById('preview-receipt-number').textContent.trim() || 'N-A';
                    const receiptDate = document.getElementById('preview-date').textContent.trim() || 'fecha';
                    const fileName = `Recibo-${receiptNumber}_${receiptDate}.pdf`;
                    
                    doc.save(fileName);
                    
                    // --- INICIO: LÓGICA DE INCREMENTO DE CORRELATIVO ---
                    const selectedEmitterId = parseInt(emitterSelectId.value);
                    const selectedEmitter = emitters.find(e => e.id === selectedEmitterId);
                    
                    if (selectedEmitter && selectedEmitter.useCorrelative) {
                        const numberUsed = parseInt(receiptNumberInput.value);
                        nextReceiptNumber = numberUsed + 1;
                        localStorage.setItem('receiptCorrelative', JSON.stringify(nextReceiptNumber));
                        
                        // Actualizar el input para el *siguiente* recibo
                        receiptNumberInput.value = String(nextReceiptNumber).padStart(3, '0');
                        receiptNumberInput.dispatchEvent(new Event('input'));
                    }
                    // --- FIN: LÓGICA DE INCREMENTO DE CORRELATIVO ---

                    
                    downloadPdfButton.disabled = false;
                    downloadPdfButton.innerHTML = originalButtonHtml;
                    deleteButtons.forEach(btn => btn.style.visibility = 'visible');

                }).catch(err => {
                    console.error("Error al generar PDF con html2canvas: ", err);
                    downloadPdfButton.disabled = false;
                    downloadPdfButton.innerHTML = originalButtonHtml;
                    deleteButtons.forEach(btn => btn.style.visibility = 'visible');
                });
                
            } catch (error) {
                console.error("Error al inicializar librerías PDF: ", error);
                downloadPdfButton.disabled = false;
                downloadPdfButton.innerHTML = originalButtonHtml;
            }
        });
        
        // Eventos del botón de Limpiar
        resetButton.addEventListener('click', () => {
            resetModal.classList.remove('hidden');
        });
        cancelResetBtn.addEventListener('click', () => {
            resetModal.classList.add('hidden');
        });
        confirmResetBtn.addEventListener('click', () => {
            receiptItems = [];
            renderReceiptPreview();
            resetModal.classList.add('hidden');
        });
        
        // --- INICIALIZACIÓN ---
        const today = new Date().toISOString().split('T')[0];
        receiptDateInput.value = today;
        serviceDateInput.value = today; 
        previewDate.textContent = new Date().toLocaleDateString('es-VE', { timeZone: 'America/Caracas' });
        // Disparar evento para lógica condicional inicial
        receiptNumberInput.dispatchEvent(new Event('input')); 

        // Renderizar todo al cargar
        renderEmittersList();
        renderRecipientsList();
        renderWorkersList();
        renderServicesList();
        renderReceiptPreview(); // Llama a renderTotals internamente
    });
    </script>
</body>
</html>








